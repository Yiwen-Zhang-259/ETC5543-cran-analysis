## compare download counts with the number of commits on master branch

In this part, we compare last half year's total downloads with the number of commits on master branch in Github repositories. Let's look back to trending packages.

```{block, type="discovery", echo = TRUE}
**Finding x**: In general, more commits on master branch of Github repository tends to bring more download counts to packages. On the one hand, the number of commits indicates that developers are constantly supplementing and updating the package, which will lead to more downloads. On the other hand, the number of commits also reflects the importance developers attach to the package to a certain extent. If a package has more commits, it means that developers attach more importance to it, then developers may invest in advertising and other ways to promote it, so as to expand the popularity and improve the download amount.
```


```{r trending-commits}
# to find the 100 trending packages before 4.11 and save as csv file

#pkg_trending <- cran_trending() 

#write_csv(pkg_trending,"data/pkg_trending.csv")

# read top 49 trending packages


pkg_trending_49 <- pkg_trending %>%
  head(49)
 

# exclude the package that only have read-only mirror of the CRAN github repo, and the remaining are 30
pkg_trending_filter <- pkg_trending_49 %>%
  filter(!(package == "proxy")) %>%
  filter(!(package == "uplift")) %>%
  filter(!(package == "spatstat.geom")) %>%
  filter(!(package == "ClickClust")) %>%
  filter(!(package == "gRc")) %>%
  filter(!(package == "anesrake")) %>%
  filter(!(package == "svd")) %>%
  filter(!(package == "textutils")) %>%
  filter(!(package == "rgl")) %>%
  filter(!(package == "tseries")) %>%
  filter(!(package == "tsDyn")) %>%
  filter(!(package == "tseriesChaos")) %>%
  filter(!(package == "penalized")) %>%
  filter(!(package == "mapdata")) %>%
  filter(!(package == "plot3D")) %>%
  filter(!(package == "ic.infer")) %>%
  filter(!(package == "misc3d")) %>%
  filter(!(package == "textshaping")) %>%
  filter(!(package == "ragg"))

```

```{r function-commits}

# function used to extract commits on master branch on Github
get_commits <- function(username,pkg){

pkg_url <- GET(glue::glue("https://api.github.com/repos/{username}/{pkg}/commits?per_page=1"))

# function used to extract commits from github page
commits <-  function(pkg_url) {
  
headers(pkg_url)$link

c <- str_split(headers(pkg_url)$link, ",") %>%
  unlist()


d <- c[str_detect(c,'rel=\"last\"')] 


f <- str_sub(d, str_locate(d, '&page=')[2]+1, str_locate(d, '>')[1]-1)

  return(f)
}
  commits(pkg_url)
 
}

```



```{r  trending-commits1}

commits <- c(get_commits("rtdists","fddm"),get_commits("r-lib","webfakes"),get_commits("nalzok","tree.interpreter"),get_commits("harryprince","geospark"),get_commits("cloudyr","AzureStor"),get_commits("spatstat","spatstat.core"),get_commits("Azure","AzureRMR"),get_commits("baddstats","spatstat.linnet"),get_commits("cran","clickstream"),get_commits("jeroen","js"),get_commits("spatstat","spatstat.sparse"),get_commits("ltorgo","DMwR2"),get_commits("daroczig","botor"),get_commits("timelyportfolio","sunburstR"),get_commits("jacob-long","panelr"),get_commits("markmfredrickson","RItools"),get_commits("DyfanJones","RAthena"),get_commits("jeroen","V8"),get_commits("timelyportfolio","d3r"),get_commits("daroczig","logger"),get_commits("dreamRs","fresh"),get_commits("nir0s","distro"),get_commits("h2oai","rsparkling"),get_commits("christophergandrud","DataCombine"),get_commits("quanteda","quanteda.textmodels"),get_commits("rstudio","bslib"),get_commits("rstudio","jquerylib"),get_commits("mclements","rstpm2"),get_commits("KlausVigo","phangorn"),get_commits("rstudio","sass"))



pkg_trending_commits <- cbind(pkg_trending_filter,as.numeric(commits)) %>%
  select(-score)

# set the time range again (last half year)
date1 <- lh_dt_start
date2 <- lh_dt_end

# get last half year's total download for each package
trending_downloads <- get_total_downloads(pkg_trending_filter$package) 
  
 #combine the trending commits and trending downloads 
trending_downloads <- left_join(trending_downloads,pkg_trending_commits, by = "package")      

```

Table \@ref(tab:commits-tbl) shows the top 30 trending packages before 2021-04-11, along with their last half a year's total downloads and the number of commits on Github master branch. `V8` ranks first in download count with `r trending_downloads$count[1]`, while `phangorn` comes to the top in commits count with `r max(trending_downloads$commits)`.

```{r commits-tbl}
trending_downloads <- trending_downloads %>%
  arrange(desc(count))

trending_downloads %>%
  kable(caption = "Top 30 scored trending packages with commits on Github and last half year's downloads") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```


Figure \@ref(fig:commits-pattern) shows the scatterplot along with a smoothing line. In general, more commits, more downloads. What's more, most packages' commits are in the range of 100 to 400.

```{r commits-pattern, fig.align = 'center', fig.cap= "The package downloads of trending packages is increasing with the number of commits."}
trending_downloads %>%
  mutate(count = as.numeric(count)) %>%
  mutate(commits = as.numeric(commits)) %>%
  ggplot(aes(x = commits, y = count)) +
  geom_point() +
  geom_smooth(se = F) +
  scale_x_log10() +
  labs( y = 'Total download count',
          x = 'The number of commits',
    title = "Commits counts against download counts",
    subtitle = "of top 30 trending packages for last half year") +
    annotate("text",y= 70000,x= 500,label="In general, more commits, more downloads.",color="red") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

```

