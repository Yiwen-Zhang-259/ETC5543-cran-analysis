## compare download counts with the number of commits on master branch

In this part, we compare last half year's total downloads with the number of commits on master branch in Github repositories. Let's look back to trending packages.

```{block, type="discovery", echo = TRUE}
**Finding**: In general, more commits on master branch of Github repository tends to bring more download counts to packages. On the one hand, the number of commits indicates that developers are constantly supplementing and updating the package, which will lead to more downloads. On the other hand, the number of commits also reflects the commitments developers attach to the package to a certain extent. If a package has more commits, it means that developers attach more commitments to it, then developers may invest in advertising and other ways to promote it, so as to expand the popularity and improve the download count.
```


```{r}
library(tidyverse)
library(rvest)
library(available)
library(xml2)
description <- sprintf("%s/web/packages/packages.rds",
                          getOption("repos")["CRAN"])
  con <- if(substring(description, 1L, 7L) == "file://") {
       file(description, "rb")
  } else {
      url(description, "rb")
  }
  db <- as.data.frame(readRDS(gzcon(con)),stringsAsFactors=FALSE)
  close(con)
  rownames(db) <- NULL

pkg_url <- db %>%
  select(Package,URL)

a <- pkg_url$URL[str_detect(pkg_url$URL,'github.com')]

pkg_url <- pkg_url%>%
  filter(URL%in%a)%>%
  na.omit() %>%
  rename(package = Package)

#replace all the "https" with "http" in URL
pkg_url$URL <- str_replace_all(pkg_url$URL, "https", "http")

#remove"<>" in URL
b <- pkg_url$URL[str_detect(pkg_url$URL,'<')]

pkg_url_adj1 <- pkg_url%>%
  filter(URL%in%b)%>%
  mutate(URL = str_remove(URL,coll(str_sub(URL, str_locate(URL, '<'))))) %>%
  mutate(URL = str_remove(URL,coll(str_sub(URL, str_locate(URL, '>')))))

pkg_url_adj1$URL[1] <- str_remove(pkg_url_adj1$URL[1],coll(str_sub(pkg_url_adj1$URL[1], str_locate(pkg_url_adj1$URL[1], ',\n')[1])))

pkg_url_adj1$URL[5] <- str_remove(pkg_url_adj1$URL[5],coll(str_sub(pkg_url_adj1$URL[5], str_locate(pkg_url_adj1$URL[5], ',')[1])))

pkg_url_adj1$URL[12] <- str_remove(pkg_url_adj1$URL[12],coll(str_sub(pkg_url_adj1$URL[12], str_locate(pkg_url_adj1$URL[12], ',\n')[1])))

pkg_url_adj1$URL[15] <- str_remove(pkg_url_adj1$URL[15],coll(str_sub(pkg_url_adj1$URL[15], str_locate(pkg_url_adj1$URL[15], ',\n')[1])))

pkg_url_adj2 <- pkg_url%>%
  filter(!(package%in%pkg_url_adj1$package))

d <- pkg_url_adj2$URL[str_detect(pkg_url_adj2$URL,'github.com')]

pkg_url_adj2 <- pkg_url_adj2 %>%
  filter(URL%in%d) 
  


#combine data 
pkg_url_rest <- pkg_url%>%
  filter(!(package%in%pkg_url_adj1$package)) %>%
  filter(!(package%in%pkg_url_adj2$package)) 
  #filter(!(package%in%pkg_url_adj22$package))

pkg_url_new <- rbind(pkg_url_rest,pkg_url_adj1,pkg_url_adj2) %>%
  arrange(package)

#get the user and repo name
pkg_url_new$URL <- str_extract(pkg_url_new$URL,coll(str_sub(pkg_url_new$URL, str_locate(pkg_url_new$URL, 'http://github.com/')[1])))

j <- pkg_url_new$URL[str_detect(pkg_url_new$URL,'github.io')]

pkg_url_new <- pkg_url_new %>%
  filter(!(URL%in%j)) %>%
 mutate(user_repo = str_sub(URL, str_locate(URL, 'github.com/')[2]+11)) %>%
  select(package,user_repo)


pkg_url_new <- pkg_url_new %>%
  mutate(user = (str_extract(user_repo,boundary("word"))))%>%
  select(package,user)

e <- pkg_url_new$user[str_detect(pkg_url_new$user,'.io')]
f <- pkg_url_new$user[str_detect(pkg_url_new$user,'.org')]
g <- pkg_url_new$user[str_detect(pkg_url_new$user,'org')]
h <- pkg_url_new$user[str_detect(pkg_url_new$user,'.com')]
i <- pkg_url_new$user[str_detect(pkg_url_new$user,'.r')]

pkg_url_new <- pkg_url_new %>%
  filter(!(user%in%e)) %>%
  filter(!(user%in%f))%>%
  filter(!(user%in%g))%>%
  filter(!(user%in%h))%>%
  filter(!(user%in%i))%>%
  filter(!(package == "abess")) %>%
  filter(!(user == "r")) %>%
  filter(!(user == "io")) %>%
  mutate(user_repo = str_c(user,"/",package))
```

```{r function-commits}
library(httr)
# extract commits on master branch on Github
get_commits <- map(pkg_url_new$user_repo, function(user_repo){

pkg_url <- GET(glue::glue("https://api.github.com/repos/{user_repo}/commits?per_page=1"))

# function used to extract commits from github page
commits <-  function(pkg_url) {
  
headers(pkg_url)$link

c <- str_split(headers(pkg_url)$link, ",") %>%
  unlist()


d <- c[str_detect(c,'rel=\"last\"')] 


f <- str_sub(d, str_locate(d, '&page=')[2]+1, str_locate(d, '>')[1]-1)

  return(f)
}
  commits(pkg_url)
 
})

#convert the list output to dataframe
commits <- data.frame(matrix(unlist(get_commits), nrow=length(get_commits), byrow=TRUE))
colnames(commits)[1] <- "commits"

#append the commits to the original data
pkg_commits <-  cbind(pkg_url_new,commits)

#combine with the total download
pkg_commits_download <- left_join(pkg_commits,cran_names_download,by = "package")
```



Table \@ref(tab:commits-tbl) shows the top 30 trending packages before 2021-04-11, along with their last half a year's total downloads and the number of commits on Github master branch. `V8` ranks first in download count with `r trending_downloads$count[1]`, while `phangorn` comes to the top in commits count with `r max(trending_downloads$commits)`.

```{r commits-tbl}
trending_downloads <- trending_downloads %>%
  arrange(desc(count))

trending_downloads %>%
  kable(caption = "Top 30 scored trending packages with commits on Github and last half year's downloads") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```


Figure \@ref(fig:commits-pattern) shows the scatterplot along with a smoothing line. In general, more commits, more downloads. What's more, most packages' commits are in the range of 100 to 400.

(ref:commits-pattern) The commits on master branch of Github repository against the last half a year's total download count.

```{r commits-pattern, fig.cap="(ref:commits-pattern)}
trending_downloads %>%
  mutate(count = as.numeric(count)) %>%
  mutate(commits = as.numeric(commits)) %>%
  ggplot(aes(x = commits, y = count)) +
  geom_point() +
  geom_smooth(se = F) +
  scale_x_log10() +
  labs( y = 'Total download count',
          x = 'The number of commits',
    title = "Commits counts against download counts",
    subtitle = "of top 30 trending packages for last half year") +
    annotate("text",y= 70000,x= 500,label="In general, more commits, more downloads.",color="red") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

```

