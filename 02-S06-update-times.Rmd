## Compare download counts with the number of updates

Next, let's look at the relationship between the number of updates and the number of downloads.
In this part, our analysis object is still all the packages.

```{block, type="discovery", echo = TRUE}
**Finding 1**: The download count tends to rise with the number of updates.This is because as we have known before, when a package is updated, there will be a significant increase in the number of downloads. That is to say, when a package is updated, not only old users will download the latest version, but also it is easier to attract new users at this time, for the increase of downloads in a short time may bring it into the trending list.
```


```{r updates-downloads-all}
# to get the number of updates
cran_names1_release <- map_dfr(cran_names1$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names2_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names3_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names4_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names5_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names6_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names7_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names8_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names9_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names10_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names11_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names12_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names13_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names14_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names15_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package)

cran_names16_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names17_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names18_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names19_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names20_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

cran_names21_release <- map_dfr(cran_names2$package, function(x) releases(x)) %>%
  group_by(package) 

pkg_updates_all <- rbind(cran_names1_release,cran_names2_release,cran_names3_release,cran_names4_release,cran_names5_release,cran_names6_release,cran_names7_release,cran_names8_release,cran_names9_release,cran_names10_release,cran_names11_release,cran_names12_release,cran_names13_release,cran_names14_release,cran_names15_release,cran_names16_release,cran_names17_release,cran_names18_release,cran_names19_release,cran_names20_release,cran_names21_release)

pkg_updates <- pkg_updates_all %>%
  group_by(package)%>%
  count(package)
```

Figure \@ref(fig:all-updates) shows that the number of downloads increases with the update times. And most packages are updated between 1 and 6 times.

(ref:all-updates) The download count increase with the number of updates.

```{r  all-updates, fig.cap="(ref:all-updates)"}
pkg_updates %>%
  ggplot(aes(x = n, y = total)) +
  geom_point() +
  geom_smooth(se = F) +
  scale_x_log10() +
    labs( x = 'The number of updates',
          y = 'Total download count',
    title = "Update counts against download counts",
    subtitle = "for all packages on CRAN") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```

```{block, type="discovery", echo = TRUE}
**Finding 2**: Over half of the packages don't tend to update very frequently.
```

Also checking Table \@ref(tab:pct-lowupdates), we can know that the percentage of trending packages whose updates are less than average is 71 %, which means much more than half of the packages do not tend to update very frequently. 

```{r  function-lowupdates}
# function used to compute packages lying in the low-updated range

compute_pct_lowupdated <- function(pkg_updates){
  
avg_updates <- mean(as.numeric(pkg_updates$n))

pkg_total <- length(pkg_updates$package)

pct_updates <- pkg_updates %>%
  mutate(n = as.numeric(n))  %>%
  dplyr::filter(n < avg_updates) %>%
  dplyr::summarise(`number of packages with low updates` = length(package)) %>%
  mutate(`percentage of packages with low updates` = (`number of packages with low updates`/pkg_total)*100)

pct_updates%>%
  kable(caption = "Percentage of trending packages whose updates are less than average") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))

return(pct_updates)

}

```

```{r pct-lowupdates}
# get the percentage of packages whose update counts is under the average
compute_pct_lowupdated(pkg_updates) 
```


```{block, type="discovery", echo = TRUE}
**Finding 3**: Most packages keep updating with the time to keep its activity.
```


```{r latestupdate-all}
# function used to get the total downloads of a period of time and the latest release date

latest_updates <- pkg_updates_all %>%
  group_by(package) %>%
  arrange(update, .by_group = TRUE) %>% #arrange within group
  top_n(1, update) # to get the latest release date, top_n() is used to select the highest value of a column within each group
  
```

It can be seen from Figure \@ref(fig:latestpublish) that most packages' latest publish date is after 2021, which indicates that popular packages tend to update by time to keep its activity.

(ref:latestpublish) The latest update dates of trending packages are almost all the recent dates.

```{r  latestpublish,fig.cap="(ref:latestpublish)"}

pkg_trending_latest_publish %>%
  ggplot(aes(update)) +
  geom_density() +
  labs( 
        x = 'Latest publish date',
    title = "Distribution of latest publish date",
    subtitle = "for all packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```


```{block, type="discovery", echo = TRUE}
**Finding 4**: Most of the packages are likely to update at a longer time interval.
```

Figure \@ref(fig:updates-perday) shows that with the increase of update interval, the number of downloads first increases and then decreases slightly. And most of the time intervals are between 45 and 450 days, which shows that their update frequency is not very high.

(ref:updates-perday) Most of the time intervals of updates are between 45 and 450 days.

```{r updates-perday,fig.cap="(ref:updates-perday)"}

pkg_trending_earliest_publish <- unique(downloads_earliest_release(pkg_trending_latest_publish$package))

pkg_trending_daily_update <- left_join(pkg_trending_earliest_publish,pkg_trending_latest_publish,by = "package") %>%
  select(-count.y) %>%
  rename(count = count.x) %>%
  mutate(release_days = as.numeric(update.y - update.x)) 

pkg_trending_daily_update$release_days <- as.character(pkg_trending_daily_update$release_days)
pkg_trending_daily_update$release_days[pkg_trending_daily_update$release_days == "0"] <- "1"

pkg_trending_daily_update$release_days <- as.numeric(pkg_trending_daily_update$release_days)

pkg_trending_daily_update <- pkg_trending_daily_update %>%
left_join(get_updates_downloads(pkg_trending_daily_update$package))

pkg_trending_daily_update %>%
  mutate(days_peruodate = release_days/`number of updates`) %>%
  ggplot(aes(x = days_peruodate, y = count)) +
  geom_point(aes(colour = `number of updates`)) +
  geom_smooth(se = F) +
  labs( y = 'Total download counts',
          x = 'Days per update',
    title = "Daily update counts against the download counts",
    subtitle = "for trending packages") +
  scale_color_continuous(trans = 'log10') +
  scale_x_log10() +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```


In conclusion, it's not that the more updates the package has, the popular it will be. In general, most of the packages whose updates are lower than the average occupy the majority. Therefore, we can also know that the total number of updates is not very important for the trending package. The important thing is to keep it updated with the time.

