# Analysis

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(pkgsearch)
library(jsonlite)
library(grid)
library(cranlogs)
library(ctv)
library(lubridate)
library(rvest)
library(htmltools)
#install.packages("jsonlite")
library(jsonlite)
#install.packages("httpuv")
library(httpuv)
#install.packages("httr")
library(httr)
library(ctv)
library(purrr)
library(kableExtra)
library(packageRank)
```

## Daily top 15 downloaded packages 

```{r readcran}
url <- "http://cran.rstudio.com/web/packages/packages.rds"
db <- readRDS(url(url)) %>% 
as.data.frame()

#cran2012_10_01 <- read_csv("data/2012-10-01 (1).csv")
#cran2013_10_01 <- read_csv("data/2013-10-01.csv")
#cran2014_10_01 <- read_csv("data/2014-10-01.csv")
#cran2015_10_01 <- read_csv("data/2015-10-01.csv")
#cran2016_10_01 <- read_csv("data/2016-10-01.csv")
#cran2017_10_01 <- read_csv("data/2017-10-01.csv")
#cran2018_10_01 <- read_csv("data/2018-10-01.csv")
#cran2019_10_01 <- read_csv("data/2019-10-01.csv")

#save(cran2012_10_01, file=here::here("data/cran2012_10_01.rda"))
#save(cran2013_10_01, file=here::here("data/cran2013_10_01.rda"))
#save(cran2014_10_01, file=here::here("data/cran2014_10_01.rda"))
#save(cran2015_10_01, file=here::here("data/cran2015_10_01.rda"))
#save(cran2016_10_01, file=here::here("data/cran2016_10_01.rda"))
#save(cran2017_10_01, file=here::here("data/cran2017_10_01.rda"))
#save(cran2018_10_01, file=here::here("data/cran2018_10_01.rda"))
#save(cran2019_10_01, file=here::here("data/cran2019_10_01.rda"))

load("data/cran2012_10_01.rda")
load("data/cran2013_10_01.rda")
load("data/cran2014_10_01.rda")
load("data/cran2015_10_01.rda")
load("data/cran2016_10_01.rda")
load("data/cran2017_10_01.rda")
load("data/cran2018_10_01.rda")
load("data/cran2019_10_01.rda")
```

```{r rstudiolist}
# filter the packages maintained by R studio

pkg_rstusio <- db %>%
  filter(grepl('RStudio', Author)) %>%
  select(Package) %>%
  rename(package = Package)

```

```{r contributorlist}
# filter the packages whose author is from R core group

pkg_core <- db %>%
  filter(grepl('Douglas Bates|John Chambers|Peter Dalgaard|Robert Gentleman|Kurt Hornik|Ross Ihaka|Tomas Kalibera|Michael Lawrence|Friedrich Leisch|Uwe Ligges|Thomas Lumley|Martin Maechler|Martin Morgan|Paul Murrell|Brian Ripley|Deepayan Sarkar|Duncan Temple Lang|Luke Tierney|Simon Urbanek|Martyn Plummer|', Author))

pkg_secondary <- db %>%
  filter(!grepl('Guido Masarotto|Duncan Murdoch|Henrik Bengtsson|Roger Bivand|Ben Bolker|David Brahm|Vince Carey|Saikat DebRoy|Matt Dowle|Dirk Eddelbuettel|Claus Ekstrom|John Fox|Paul Gilbert|Yu Gong|Gabor Grothendieck|Frank E Harrell Jr|Peter M. Haverty|Torsten Hothorn|Robert King|Kjetil Kjernsmo|Roger Koenker|Philippe Lambert|Jan de Leeuw|Jim Lindsey|Patrick Lindsey|Catherine Loader| Gordon Maclean|Arni Magnusson|John Maindonald|David Meyer|Ei-ji Nakama|Jens Oehlschägel|Steve Oncley|Richard O’Keefe|Hubert Palme|Roger D. Peng|José C. Pinheiro|Tony Plate|Anthony Rossini| Jonathan Rougier|Petr Savicky|Günther Sawitzki|Marc Schwartz|Arun Srinivasan|Detlef Steuer|Bill Simpson|Gordon Smyth|Adrian Trapletti|Terry Therneau|Rolf Turner|Bill Venables|Gregory R. Warnes| Andreas Weingessel|Morten Welinder|James Wettenhall|Simon Wood|and Achim Zeileis', Author)) %>%
  select(Package) %>%
  rename(package = Package)


```

```{r top20activelist}
# filter the packages developed by top 20 prolific maintainers
pkg_20maintainer <- db %>% 
  filter(stringr::str_detect(Author, 'Hadley Wickham|Yihui Xie|Dirk Eddelbuettel|Jeroen Ooms|Achim Zeileis|Scott Chamberlain|Gabor Csardi|Jeroen Ooms|ORPHANED|Thomas J. Leeper|Bob Rudis|Henrik Bengtsson|Kurt Hornik|Oliver Keyes|Martin Maechler|Richard Cotton|Robin K. S. Hankin|Simon Urbanek|Kirill Muller|Torsten Hothorn|Paul Gilbert') )%>%
  select(Package) %>%
  rename(package = Package)

# filter the packages developed by other R studio related authors

pkg_r_related <- db %>%
  filter(stringr::str_detect(Author, 'Hadley Wickham|Yihui Xie|Gabor Csardi|Winston Chang|Andrie de Vries|Alison Presmanes Hill|Mara Averick|Cole Arendt|Daniel Falbel|Garrick Aden-Buie|Garrett Grolemund|Gary|Joe Cheng|Jennifer (Jenny) Bryan|Jim Hester|J.J. Allaire|Jonathan|Joshua Spiewak|Dan Buch|Richard Iannone|Ralf Stubner|Tyler Finethy|Melissa Barca|Kevin Ushey|Javier Luraschi|Karl Feinauer|Charles Teague|Maria Semple|adamconroy|Ricardo Andrade|Steve Nolen|Randy Lai|Jeffrey Horner|Jan Marvin Garbuszus|Justace Clutter|Josh Paulson|Mike Bessuille|Jeffrey Arnold|Paul Kaefer|Jim Hester|Dirk Schumacher|
Philipp A.|Fabian Mundt|Fabian Mundt|boB Rudis|Asher|Henrik Bengtsson|James Lamb|rich-rstudio|Andrie de Vries|Iñaki Ucar|Mark Brown|Hiroaki Yutani|Dean Attali|Matthias Mailänder|Bruno Tremblay|Ian|John Blischak|Chris von Csefalvay|Jeroen Ooms|
Daniel Gromer|Kirill Müller|Jan Gleixner|Alexander Grueneberg|Darío Hereñú|Aron Atkins|harupiko|Barret Schloerke|James Arnold|Giuseppe Casalicchio|Fredric Johansson|Curtis Kephart|reudismam|Jeff Allen|Yuri Niyazov|Sean Kross|Carl A. B. Pearson|
Peter Glerup Ericson|Diomidis Spinellis|Paul Menzel|Lincoln Mullen|Colin Gillespie|Masafumi Okada|Øystein Sørensen|Matthew Grogan|Scott Kostyshak|Marcus Kinsella|rhinopotamus|Daiki Katsuragawa|Michael Steinbaugh|Jari Karppinen|Roy Storey|Kristofer Rye|Erin|Ben Torvaney|Pol Mesalles|Sainath Adapa|Vladimir Panfilov|Christian Brueffer|Julien Barnier|') )%>%
  select(Package) %>%
  rename(package = Package)
```

```{r filterlist}
# exclude the packages in the above three lists
cran2019_10_01_new <- cran2019_10_01 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))

cran2018_10_01_new <- cran2018_10_01 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))


cran2017_10_01_new <- cran2017_10_01 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))

cran2016_10_01_new <- cran2016_10_01 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))

cran2015_10_01_new <- cran2015_10_01 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))

cran2014_10_01_new <- cran2014_10_01 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))

cran2013_10_01_new <- cran2013_10_01 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))

#cran2012_10_01_new <- cran2012_10_01 %>%
     #filter(!(package %in% pkg_20maintainer$package)) %>%
     #filter(!(package %in% pkg_secondary$package)) %>%
     #filter(!(package %in% pkg_rstusio$package)) %>%
     #filter(!(package %in% pkg_core$package)) %>%
     #filter(!(package %in% pkg_r_related$package))
```


```{r  cran20121001}
#cran2012_1001 <- cran2012_10_01_new %>%
  #drop_na() %>%
  #count(package) %>%
  #arrange(desc(n)) %>%
 # head(15) 
  
#cran2012_1001$package <- as.vector(cran2012_1001$package) #get rid of factors

#cran2012_1001$package = factor(cran2012_1001$package,cran2012_1001$package)

#p1 <- ggplot(data = cran2012_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2012-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```


```{r cran20131001}
cran2013_1001 <- cran2013_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2013_1001$package <- as.vector(cran2013_1001$package) #get rid of factors

cran2013_1001$package = factor(cran2013_1001$package,cran2013_1001$package)

 p2 <- ggplot(data = cran2013_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2013-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20141001}
cran2014_1001 <- cran2014_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2014_1001$package <- as.vector(cran2014_1001$package) #get rid of factors

cran2014_1001$package = factor(cran2014_1001$package,cran2014_1001$package)

p3 <- ggplot(data = cran2014_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2014-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20151001}
cran2015_1001 <- cran2015_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2015_1001$package <- as.vector(cran2015_1001$package) #get rid of factors

cran2015_1001$package = factor(cran2015_1001$package,cran2015_1001$package)

p4 <- ggplot(data = cran2015_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2015-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20161001}
cran2016_1001 <- cran2016_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2016_1001$package <- as.vector(cran2016_1001$package) #get rid of factors

cran2016_1001$package = factor(cran2016_1001$package,cran2016_1001$package)

p5 <- ggplot(data = cran2016_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2016-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20171001}
cran2017_1001 <- cran2017_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2017_1001$package <- as.vector(cran2017_1001$package) #get rid of factors

cran2017_1001$package = factor(cran2017_1001$package,cran2017_1001$package)

p6 <- ggplot(data = cran2017_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2017-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20181001}
cran2018_1001 <- cran2018_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2018_1001$package <- as.vector(cran2018_1001$package) #get rid of factors

cran2018_1001$package = factor(cran2018_1001$package,cran2018_1001$package)

p7 <- ggplot(data = cran2018_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2018-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20191001}
cran2019_1001 <- cran2019_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2019_1001$package <- as.vector(cran2019_1001$package) #get rid of factors

cran2019_1001$package = factor(cran2019_1001$package,cran2019_1001$package)

p8 <- ggplot(data = cran2019_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2019-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```


```{r compareby2year}
# display the daily top 15 popular packages on 10-01 of each year from 2012 to 2019
#g1 <- ggplotGrob(p1)
g2 <- ggplotGrob(p2)
#g12 <- rbind(g1, g2, size = "first")
#g12$widths <- unit.pmax(g1$widths, g2$widths)
grid.newpage()
grid.draw(g2)

g3 <- ggplotGrob(p3)
g4 <- ggplotGrob(p4)
g34 <- rbind(g3, g4, size = "first")
g34$widths <- unit.pmax(g3$widths, g4$widths)
grid.newpage()
grid.draw(g34)

g5 <- ggplotGrob(p5)
g6 <- ggplotGrob(p6)
g56 <- rbind(g5, g6, size = "first")
g56$widths <- unit.pmax(g5$widths, g6$widths)
grid.newpage()
grid.draw(g56)

g7 <- ggplotGrob(p7)
g8 <- ggplotGrob(p8)
g78 <- rbind(g7, g8, size = "first")
g78$widths <- unit.pmax(g7$widths, g8$widths)
grid.newpage()
grid.draw(g78)
```

## Compare last half year's downloads with the release date

In our common cognition, we think that the earlier a package is released, the more people will know about it, and thus the more downloads it will have. However, packages related to different topics cannot be directly compared, because it is possible that the total download amount of packages in a certain topic is higher than that in another topic. Therefore, in order to test this conjecture as clearly as possible, I selected three domain packages through CRAN task view, calculated their respective downloads in the previous two years, and found their release dates for comparison.

1. Packages for Time Series Analysis


```{r}
# function used to get rid of 'AsIs' class attributes
unAsIs <- function(X) {
    if("AsIs" %in% class(X)) {
        class(X) <- class(X)[-match("AsIs", class(X))]
    }
    X
}


# the packages for econometrics
Econometrics <- read.ctv(system.file("ctv", "Econometrics.ctv", package = "ctv")) 

Econometrics <- list(Econometrics)

Econometrics <- lapply(Econometrics, '[', 8) %>%
  as.data.frame() 

Econometrics <- Econometrics %>%
     filter(packagelist.core == "FALSE") %>%  # to filter the core package 
     filter(!(packagelist.name %in% pkg_20maintainer$package)) %>%
     filter(!(packagelist.name %in% pkg_secondary$package)) %>%
     filter(!(packagelist.name %in% pkg_rstusio$package)) %>%
     filter(!(packagelist.name %in% pkg_core$package)) %>%
     filter(!(packagelist.name %in% pkg_r_related$package)) %>%
     select(-packagelist.core) %>%
     mutate(count = cran_downloads(packages = packagelist.name)) %>%
     arrange(desc(count)) %>%
     head(10)


# the packages for time series
TimeSeries <- read.ctv(system.file("ctv", "TimeSeries.ctv", package = "ctv")) 

TimeSeries <- list(TimeSeries)

TimeSeries <- lapply(TimeSeries, '[', 8) %>%
  as.data.frame() 

TimeSeries <- TimeSeries %>%
     filter(packagelist.core == "FALSE") %>%  # to filter the core package 
     filter(!(packagelist.name %in% pkg_20maintainer$package)) %>%
     filter(!(packagelist.name %in% pkg_secondary$package)) %>%
     filter(!(packagelist.name %in% pkg_rstusio$package)) %>%
     filter(!(packagelist.name %in% pkg_core$package)) %>%
     filter(!(packagelist.name %in% pkg_r_related$package)) %>%
     select(-packagelist.core) %>%
     mutate(count = cran_downloads(packages = packagelist.name)) %>%
     arrange(desc(count)) %>%
     head(10)
                                            # when I try to filter packages according to the filtering lists, the output is none or does not change, so in this case maybe filter core is enough


# the packages for bayesian
Bayesian <- read.ctv(system.file("ctv", "Bayesian.ctv", package = "ctv")) 

Bayesian <- list(Bayesian)

Bayesian <- lapply(Bayesian, '[', 8) %>%
  as.data.frame() 

Bayesian <- Bayesian %>%
     filter(packagelist.core == "FALSE") %>%  # to filter the core package 
     filter(!(packagelist.name %in% pkg_20maintainer$package)) %>%
     filter(!(packagelist.name %in% pkg_secondary$package)) %>%
     filter(!(packagelist.name %in% pkg_rstusio$package)) %>%
     filter(!(packagelist.name %in% pkg_core$package)) %>%
     filter(!(packagelist.name %in% pkg_r_related$package)) %>%
     select(-packagelist.core) %>%
     mutate(count = cran_downloads(packages = packagelist.name)) %>%
     arrange(desc(count)) %>%
     head(10)

```

```{r}
Econometrics %>%
  kable(caption = "Last day top 10 downloaded packages of Econometrics from CRAN task view") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```

```{r}
TimeSeries %>%
  kable(caption = "Last day top 10 downloaded packages of TimeSeries from CRAN task view") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

```{r}
Bayesian %>%
  kable(caption = "Last day top 10 downloaded packages of Bayesian from CRAN task view") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

It can be seen from Figure \@ref(fig:timeseries) that the most downloaded package for the past six months is `wmtsa` whose release date is 2007-09-06, a relatively early date. And the second downloaded one is `fractal` released on the same day.

And we could see that `pear`, `tsfa`, `fractalrock` and `CommonTrend` have similar downloads that are higher than the rest of the packages. However, some of them were released before 2010 and some after 2010, showing no obvious time difference.

```{r timeseries, fig.align = 'center', fig.cap="The older package 'fable' has less download count than that of package 'forecast'."}

date1 <- "2019-10-01"
date2 <- "2020-04-01"

cts <- cran_downloads(package = "cts", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

MSBVAR <- cran_downloads(package = "MSBVAR", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

tsfa <- cran_downloads(package = "tsfa", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

wmtsa <- cran_downloads(package = "wmtsa", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

fractal <- cran_downloads(package = "fractal", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

FGN <- cran_downloads(package = "FGN", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
	
rdatamarket <- cran_downloads(package = "rdatamarket", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

pear  <- cran_downloads(package = "pear", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

fractalrock  <- cran_downloads(package = "fractalrock", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

CommonTrend  <- cran_downloads(package = "CommonTrend", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

timeseries <- rbind(cts,MSBVAR,tsfa,wmtsa,fractal,FGN,rdatamarket,pear,fractalrock,CommonTrend) %>%
  group_by(package) 

timeseries <- as.data.frame(timeseries)

release_date <- c("2006-06-23","2005-09-20","2006-02-11","2007-09-06","2007-09-06","2007-11-23","2011-08-23 ","2002-01-13","2009-06-08","2011-11-18")


timeseries <- cbind(timeseries,release_date) 


timeseries %>%
  ggplot(aes(x = release_date, y = count,fill = package)) +
  geom_bar(stat = "identity") +
    labs( y = 'Download count',
    title = "Last half year's downloads with the release date",
    subtitle = "between for time series packages") +
  scale_y_sqrt() + # to change the scale of y axis
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

2. Bayesian packages for general model fitting

Let's have a look at the bayesian packages. It can be seen from Figure \@ref(fig:bayesian) that the most downloaded packages is `geoRglm` released on 2002-02-13. Then package `profdpm` released on 2009-11-15 and `abn` released on 2011-07-26 are also highly downloaded, which come from the relatively recent date. Then the difference in the downloads of other packages is not very significant.

Therefore, in this type of packages, we can say that the later the release date, the lower the download volume of the package. But there are still some special cases. That is even if the release date is later, the download volume is still not ideal such as `growcurves`,  which may be due to other reasons.

```{r bayesian,fig.align = 'center', fig.cap="last two years' downloads with the release date for bayesian general model fitting packages."}

geoRglm <- cran_downloads(package = "geoRglm", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

RJaCGH <- cran_downloads(package = "RJaCGH", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

rbugs <- cran_downloads(package = "rbugs", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

abn <- cran_downloads(package = "abn", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

MSBVAR <- cran_downloads(package = "MSBVAR", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

growcurves <- cran_downloads(package = "growcurves", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
	
eco <- cran_downloads(package = "eco", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

glmmBUGS  <- cran_downloads(package = "glmmBUGS", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

cudaBayesreg  <- cran_downloads(package = "cudaBayesreg", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

profdpm  <- cran_downloads(package = "profdpm", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

bayesian7 <- rbind(geoRglm,RJaCGH,rbugs,abn,MSBVAR,growcurves,eco,glmmBUGS,cudaBayesreg,profdpm) %>%
  group_by(package) 

bayesian7 <- as.data.frame(bayesian7)

release_date <- c("2002-02-13","2006-07-18","2004-05-13","2011-07-26","2005-09-20","2012-03-25","2004-12-21","2008-09-09","2009-10-19","2009-11-15")

bayesian7 <- cbind(bayesian7,release_date) 


bayesian7 %>%
  ggplot(aes(x = release_date, y = count,fill = package)) +
  geom_bar(stat = "identity") +
    labs( y = 'Download count',
          x = 'Relsease date',
    title = "Last two years' downloads with the release date",
    subtitle = "for bayesian packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1)) 

```

3. Econometrics for basic linear regression

In order to test whether this is the case in other areas, let's turn our attention to econometrics packages. 

It can be seen from Figure \@ref(fig:eco-lm) that the second oldest package `tsfa` has the highest downloads, while the downloads of `rddtools` with the second earliest release date is much close to it.

This is quite different to Bayesian's case, that is, although the most downloaded package comes from early date, the second downloaded package comes from newer date, and the overall download volume of packages released after 2013 is higher.

Therefore, in this case, except for the package with the highest download, the packages with the later release date are more likely to have higher downloads.

```{r eco-lm,fig.align = 'center', fig.cap="The latest package 'sandwich` has the highest downloads."}
MSBVAR <- cran_downloads(package = "MSBVAR", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

tsfa <- cran_downloads(package = "tsfa", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

SemiParSampleSel <- cran_downloads(package = "SemiParSampleSel", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

intReg <- cran_downloads(package = "intReg", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

rUnemploymentData <- cran_downloads(package = "rUnemploymentData", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
	
rddapp <- cran_downloads(package = "rddapp", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
	
PANICr <- cran_downloads(package = "PANICr", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

phtt  <- cran_downloads(package = "phtt", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

rddtools  <- cran_downloads(package = "rddtools", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

ivbma  <- cran_downloads(package = "ivbma", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

eco_lm <- rbind(MSBVAR,tsfa,SemiParSampleSel,intReg,rUnemploymentData,rddapp,PANICr,phtt,rddtools,ivbma) %>%
  group_by(package) 

eco_lm <- as.data.frame(eco_lm)

release_date <- c("2005-09-20","2006-02-11","2012-04-30","2012-01-12","2015-01-04","2017-12-12","2014-10-24","2013-02-25","2015-07-27","2012-02-29")

eco_lm <- cbind(eco_lm,release_date) 

eco_lm %>%
  ggplot(aes(x = release_date, y = count,fill = package)) +
  geom_bar(stat = "identity") +
    labs( y = 'Download count',
          x = 'Relsease date',
    title = "Last half year's downloads with the release date",
    subtitle = "for econometrics packages") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1)) 

```

4. trending packages

In conclusion, I'm surprised to find it's not that the earlier the package is released, the more downloads it has. And the most downloaded packages are often from the earlier date, which is reflected in bayesian, econometrics, time series. But packages from later date also have quite high downloads, and for econometrics packages, it shows that the later the release date, the higher the downloads.

## compare packages with similar release date

I would like to compare packages released on the same date (i.e. April 1st, 2021), so I compare the daily downloads of these packages for 04-02.

By looking into Figure \@ref(fig:pkg0401), we could know that the most downloaded package released on 04-01 is `datetimeutils`, and the second one is `berryFunctions`.

```{r}
# Store web url
#crandate <- read_html("https://cran.r-project.org/web/packages/available_packages_by_date.html")

#Scrape the website for the movie rating

#date <- crandate %>% 
  #html_nodes("tr:nth-child(2) td:nth-child(1)") %>%
  #html_text() 

#package <- crandate %>% 
  #html_nodes("tr:nth-child(2) a") %>%
  #html_text()

#pkg_similar_date <- data.frame(date, package)
```

```{r pkg0401, fig.align = 'center', fig.cap="The highest downloaded package 'proxy' is released on 2021-03-05."}
package_0401 <- c("backbone","bbdetection","berryFunctions","bootImpute","ChineseNames","chromoMap","cocktailApp","datetimeutils","deepdive","diversityForest","DLMtool","ecb","EValue","fungible","GetDFPData","gh","insight","LAWBL","mapping","marqLevAlg","microbial","mockcpp","mrbayes","muhaz","NetOrigin","NMOF","PDE","ProcData","PSweight","rbiorxiv","relevance","remotes","rmcorr","samc","scam","sigminer","sisireg","smcfcs","textutils","tsBSS") %>%
  as.data.frame() %>%
  rename(package_0401,package = .)

package_0401 <- package_0401 %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))
     head(15)

backbone <- cran_downloads(package = "backbone")
bbdetection <- cran_downloads(package = "bbdetection")
berryFunctions <- cran_downloads(package = "berryFunctions")
bootImpute <- cran_downloads(package = "bootImpute")
chromoMap <- cran_downloads(package = "chromoMap")
cocktailApp <- cran_downloads(package = "cocktailApp")
datetimeutils <- cran_downloads(package = "datetimeutils")
deepdive <- cran_downloads(package = "deepdive")
diversityForest <- cran_downloads(package = "diversityForest")
DLMtool <- cran_downloads(package = "DLMtool")
ecb <- cran_downloads(package = "ecb")
fungible <- cran_downloads(package = "fungible")
GetDFPData <- cran_downloads(package = "GetDFPData")

package_0401 <- rbind(backbone,bbdetection,berryFunctions,bootImpute,chromoMap,cocktailApp,datetimeutils,deepdive,diversityForest,DLMtool,ecb,fungible,GetDFPData) %>%
  group_by(package)

package_0401 %>%
  ggplot(aes(x = package, y = count)) +
  geom_bar(stat = "identity") +
    labs( y = 'Package',
          x = 'Download count',
    title = "The daily downloads of packages released on 04-01",
    subtitle = "on 04-02") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1)) 
```

## Compare increase rate of fable and forecast

To compare the increase rate of `fable` and `forecast`, I use the daily downloads of both packages from 2021-02-03 to 2021-04-02 and compute the daily growth  download rate. The reason I choose this period of time is that `fable` is published on CRAN from 2021-02-03.

```{r}
fable <- cran_downloads(package = "fable", from = "2021-02-03", to = "2021-04-02") 

fable_past <- fable %>%
  summarise(package = package, avg_count = mean(count)) %>% # get the average daily count for past 8 weeks
  head(1) 

fable_now <- cran_downloads(package = "fable", from = "2021-04-02", to = "2021-04-03")

fable_past <- fable_past %>%
  mutate(increase = (fable_now$count[2] - avg_count)/avg_count * 100)

forecast <- cran_downloads(package = "forecast", from = "2021-02-03", to = "2021-04-02") 

forecast_past <- forecast %>%
  summarise(package = package, avg_count = mean(count)) %>% # get the average daily count for past 8 weeks
  head(1) 

forecast_now <- cran_downloads(package = "forecast", from = "2021-04-02", to = "2021-04-03")

forecast_past <- forecast_past %>%
  mutate(increase = (forecast_now$count[2] - avg_count)/avg_count * 100)

fcst_fbl <- rbind(fable_past,forecast_past)

fcst_fbl %>%
  ggplot(aes(x = package, y = increase)) +
  geom_bar(stat = "identity") +
    labs( y = 'Package',
          x = 'Incease date',
    title = "The incease rate of fable and forecast") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5)) 

```

It can be seen from Figure \@ref(fig:fbl-fcst) that generally speaking, the daily download rate of `forecast` is more stable than that of `fable`. And the daily download rate of package `fable` grew significantly before March 1, while `forecast` increased more moderately. From March 1 to March 15, both packages show decrease in download rate, and `forecast` decreased faster while `forecast` decreased slower.
After March 15, the daily download rates of the two packages continued to decline at a similar rate.

Therefore, we can also see that although `forecast` has more downloads than `fable` in the past two years, the growth rate of `forecast`'s single day downloads is significantly lower than `fable`'s, from February 3, 2021 to March 1, 2021. It shows that although the total download amount of the old package may be larger, the growth rate of the new package from the same topic may be higher than that of the old one in a period of time, which may be near the release date or the update date of the new package.

```{r fbl-fcst, pkg0401, fig.align = 'center', fig.cap="fable grew significantly before March 1."}
#compute the daily change compared to the last day
fable_lag <- fable %>%
  mutate(behind = lag(count)) %>%
  mutate(increase = (count - behind)/behind)
  
forecast_lag <- forecast %>%
  mutate(behind = lag(count)) %>%
  mutate(increase = (count - behind)/behind)

fbl_fcst <- full_join(fable_lag,forecast_lag,by = "date") %>%
  mutate(date = as.Date(date))

colors <- c('fable' = 'darkblue', 'forecast' = 'red')

fbl_fcst %>%
  ggplot() +
  geom_smooth(aes(x = date,y = increase.x,colour = "fable"),position = "identity",se = FALSE) +
  geom_smooth(aes(x = date,y = increase.y,colour = "forecast"),position = "identity",se = FALSE) +
  labs( y = 'Date',
        x = 'Incease rate',
    title = "Daily download increase rate between fable and forecast") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5)) 
  
```


## compare download logs with the number of commits

```{r}
# function used to get the number of commits from github page
get_commits <- function(pkg){
  
  commits <- pkg %>% 
  html_nodes(xpath = "//*[@id='repo-content-pjax-container']/div/div[2]/div[1]/div[2]/div[1]/div/div[4]/ul/li/a") %>%
  html_text()

package <- pkg %>% 
  html_nodes(xpath = "//*[@id='js-repo-pjax-container']/div[1]/div[1]/div/h1/strong/a") %>%
  html_text()

glue <- data.frame(commits,packages)

return(glue)

}

# six packages from top 15 on 2019-10-01
glue <- read_html("https://github.com/tidyverse/glue")
backports <- read_html("https://github.com/r-lib/backports")
fansi <- read_html("https://github.com/brodieG/fansi")
R6 <- read_html("https://github.com/r-lib/R6/")
stringi <- read_html("https://github.com/gagolews/stringi")
munsell <- read_html("https://github.com/cwickham/munsell/")


glue <- get_commits(glue)
backports <- get_commits(backports)
fansi <- get_commits(fansi)
R6 <- get_commits(R6)
stringi <- get_commits(stringi)
munsell <- get_commits(munsell)

commits_191001 <- rbind(glue,backports,fansi,R6,stringi,munsell)

# to get the last two years' total downloads
glue <- cran_downloads(package = "glue", from = "2019-04-01", to = "2021-04-01") %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

backports <- cran_downloads(package = "backports", from = "2019-04-01", to = "2021-04-01") %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

fansi <- cran_downloads(package = "fansi", from = "2019-04-01", to = "2021-04-01") %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

R6 <- cran_downloads(package = "R6", from = "2019-04-01", to = "2021-04-01") %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

stringi <- cran_downloads(package = "stringi", from = "2019-04-01", to = "2021-04-01") %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

munsell <- cran_downloads(package = "munsell", from = "2019-04-01", to = "2021-04-01") %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

counts_191001 <- rbind(glue,backports,fansi,R6,stringi,munsell)

commits_count_191001 <- full_join(commits_191001,counts_191001, by = "package")

```

