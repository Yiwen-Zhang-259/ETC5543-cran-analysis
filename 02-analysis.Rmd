# Analysis

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(pkgsearch)
library(jsonlite)
library(grid)
library(cranlogs)
library(ctv)
library(lubridate)
library(rvest)
library(htmltools)
#install.packages("jsonlite")
library(jsonlite)
#install.packages("httpuv")
library(httpuv)
#install.packages("httr")
library(httr)
library(ctv)
library(purrr)
library(kableExtra)
library(packageRank)
library(fpp3)
library(slider)
library(stringr)
library(lubridate)
library(dplyr)
library(rvest)
library(glue)
```

## Daily top 15 downloaded packages 

```{r readcran}
url <- "http://cran.rstudio.com/web/packages/packages.rds"
db <- readRDS(url(url)) %>% 
as.data.frame()

#cran2012_10_01 <- read_csv("data/2012-10-01 (1).csv")
#cran2013_10_01 <- read_csv("data/2013-10-01.csv")
#cran2014_10_01 <- read_csv("data/2014-10-01.csv")
#cran2015_10_01 <- read_csv("data/2015-10-01.csv")
#cran2016_10_01 <- read_csv("data/2016-10-01.csv")
#cran2017_10_01 <- read_csv("data/2017-10-01.csv")
#cran2018_10_01 <- read_csv("data/2018-10-01.csv")
#cran2019_10_01 <- read_csv("data/2019-10-01.csv")

#save(cran2012_10_01, file=here::here("data/cran2012_10_01.rda"))
#save(cran2013_10_01, file=here::here("data/cran2013_10_01.rda"))
#save(cran2014_10_01, file=here::here("data/cran2014_10_01.rda"))
#save(cran2015_10_01, file=here::here("data/cran2015_10_01.rda"))
#save(cran2016_10_01, file=here::here("data/cran2016_10_01.rda"))
#save(cran2017_10_01, file=here::here("data/cran2017_10_01.rda"))
#save(cran2018_10_01, file=here::here("data/cran2018_10_01.rda"))
#save(cran2019_10_01, file=here::here("data/cran2019_10_01.rda"))

load("data/cran2012_10_01.rda")
load("data/cran2013_10_01.rda")
load("data/cran2014_10_01.rda")
load("data/cran2015_10_01.rda")
load("data/cran2016_10_01.rda")
load("data/cran2017_10_01.rda")
load("data/cran2018_10_01.rda")
load("data/cran2019_10_01.rda")
```

```{r filter-list}
# filter the packages maintained by R studio
pkg_rstusio <- db %>%
  filter(grepl('RStudio', Author)) %>%
  select(Package) %>%
  rename(package = Package)


# filter the packages whose author is from R core group
pkg_core <- db %>%
  filter(grepl('Douglas Bates|John Chambers|Peter Dalgaard|Robert Gentleman|Kurt Hornik|Ross Ihaka|Tomas Kalibera|Michael Lawrence|Friedrich Leisch|Uwe Ligges|Thomas Lumley|Martin Maechler|Martin Morgan|Paul Murrell|Brian Ripley|Deepayan Sarkar|Duncan Temple Lang|Luke Tierney|Simon Urbanek|Martyn Plummer|', Author))

pkg_secondary <- db %>%
  filter(!grepl('Guido Masarotto|Duncan Murdoch|Henrik Bengtsson|Roger Bivand|Ben Bolker|David Brahm|Vince Carey|Saikat DebRoy|Matt Dowle|Dirk Eddelbuettel|Claus Ekstrom|John Fox|Paul Gilbert|Yu Gong|Gabor Grothendieck|Frank E Harrell Jr|Peter M. Haverty|Torsten Hothorn|Robert King|Kjetil Kjernsmo|Roger Koenker|Philippe Lambert|Jan de Leeuw|Jim Lindsey|Patrick Lindsey|Catherine Loader| Gordon Maclean|Arni Magnusson|John Maindonald|David Meyer|Ei-ji Nakama|Jens Oehlschägel|Steve Oncley|Richard O’Keefe|Hubert Palme|Roger D. Peng|José C. Pinheiro|Tony Plate|Anthony Rossini| Jonathan Rougier|Petr Savicky|Günther Sawitzki|Marc Schwartz|Arun Srinivasan|Detlef Steuer|Bill Simpson|Gordon Smyth|Adrian Trapletti|Terry Therneau|Rolf Turner|Bill Venables|Gregory R. Warnes| Andreas Weingessel|Morten Welinder|James Wettenhall|Simon Wood|and Achim Zeileis', Author)) %>%
  select(Package) %>%
  rename(package = Package)


# filter the packages developed by top 20 prolific maintainers
pkg_20maintainer <- db %>% 
  filter(stringr::str_detect(Author, 'Hadley Wickham|Yihui Xie|Dirk Eddelbuettel|Jeroen Ooms|Achim Zeileis|Scott Chamberlain|Gabor Csardi|Jeroen Ooms|ORPHANED|Thomas J. Leeper|Bob Rudis|Henrik Bengtsson|Kurt Hornik|Oliver Keyes|Martin Maechler|Richard Cotton|Robin K. S. Hankin|Simon Urbanek|Kirill Muller|Torsten Hothorn|Paul Gilbert') )%>%
  select(Package) %>%
  rename(package = Package)


# filter the packages developed by other R studio related authors
pkg_r_related <- db %>%
  filter(stringr::str_detect(Author, 'Hadley Wickham|Yihui Xie|Gabor Csardi|Winston Chang|Andrie de Vries|Alison Presmanes Hill|Mara Averick|Cole Arendt|Daniel Falbel|Garrick Aden-Buie|Garrett Grolemund|Gary|Joe Cheng|Jennifer (Jenny) Bryan|Jim Hester|J.J. Allaire|Jonathan|Joshua Spiewak|Dan Buch|Richard Iannone|Ralf Stubner|Tyler Finethy|Melissa Barca|Kevin Ushey|Javier Luraschi|Karl Feinauer|Charles Teague|Maria Semple|adamconroy|Ricardo Andrade|Steve Nolen|Randy Lai|Jeffrey Horner|Jan Marvin Garbuszus|Justace Clutter|Josh Paulson|Mike Bessuille|Jeffrey Arnold|Paul Kaefer|Jim Hester|Dirk Schumacher|
Philipp A.|Fabian Mundt|Fabian Mundt|boB Rudis|Asher|Henrik Bengtsson|James Lamb|rich-rstudio|Andrie de Vries|Iñaki Ucar|Mark Brown|Hiroaki Yutani|Dean Attali|Matthias Mailänder|Bruno Tremblay|Ian|John Blischak|Chris von Csefalvay|Jeroen Ooms|
Daniel Gromer|Kirill Müller|Jan Gleixner|Alexander Grueneberg|Darío Hereñú|Aron Atkins|harupiko|Barret Schloerke|James Arnold|Giuseppe Casalicchio|Fredric Johansson|Curtis Kephart|reudismam|Jeff Allen|Yuri Niyazov|Sean Kross|Carl A. B. Pearson|
Peter Glerup Ericson|Diomidis Spinellis|Paul Menzel|Lincoln Mullen|Colin Gillespie|Masafumi Okada|Øystein Sørensen|Matthew Grogan|Scott Kostyshak|Marcus Kinsella|rhinopotamus|Daiki Katsuragawa|Michael Steinbaugh|Jari Karppinen|Roy Storey|Kristofer Rye|Erin|Ben Torvaney|Pol Mesalles|Sainath Adapa|Vladimir Panfilov|Christian Brueffer|Julien Barnier|') )%>%
  select(Package) %>%
  rename(package = Package)

```


```{r filter-function}
filter_list <- function(pkg){
  
  pkg <- pkg %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))
  
  return(pkg)
}
```


```{r filterlist}
# exclude the packages in the above three lists
cran2019_10_01_new <- filter_list(cran2019_10_01)
cran2018_10_01_new <- filter_list(cran2018_10_01)
cran2017_10_01_new <- filter_list(cran2017_10_01)
cran2016_10_01_new <- filter_list(cran2016_10_01)
cran2015_10_01_new <- filter_list(cran2015_10_01)
cran2014_10_01_new <- filter_list(cran2014_10_01)
cran2013_10_01_new <- filter_list(cran2013_10_01)
```


```{r cran20131001}
cran2013_1001 <- cran2013_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2013_1001$package <- as.vector(cran2013_1001$package) #get rid of factors

cran2013_1001$package = factor(cran2013_1001$package,cran2013_1001$package)

 p2 <- ggplot(data = cran2013_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2013-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20141001}
cran2014_1001 <- cran2014_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2014_1001$package <- as.vector(cran2014_1001$package) #get rid of factors

cran2014_1001$package = factor(cran2014_1001$package,cran2014_1001$package)

p3 <- ggplot(data = cran2014_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2014-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20151001}
cran2015_1001 <- cran2015_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2015_1001$package <- as.vector(cran2015_1001$package) #get rid of factors

cran2015_1001$package = factor(cran2015_1001$package,cran2015_1001$package)

p4 <- ggplot(data = cran2015_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2015-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20161001}
cran2016_1001 <- cran2016_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2016_1001$package <- as.vector(cran2016_1001$package) #get rid of factors

cran2016_1001$package = factor(cran2016_1001$package,cran2016_1001$package)

p5 <- ggplot(data = cran2016_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2016-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20171001}
cran2017_1001 <- cran2017_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2017_1001$package <- as.vector(cran2017_1001$package) #get rid of factors

cran2017_1001$package = factor(cran2017_1001$package,cran2017_1001$package)

p6 <- ggplot(data = cran2017_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2017-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20181001}
cran2018_1001 <- cran2018_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2018_1001$package <- as.vector(cran2018_1001$package) #get rid of factors

cran2018_1001$package = factor(cran2018_1001$package,cran2018_1001$package)

p7 <- ggplot(data = cran2018_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2018-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

```{r cran20191001}
cran2019_1001 <- cran2019_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) 
  
cran2019_1001$package <- as.vector(cran2019_1001$package) #get rid of factors

cran2019_1001$package = factor(cran2019_1001$package,cran2019_1001$package)

p8 <- ggplot(data = cran2019_1001) +
  geom_bar(stat="identity", aes(x = package, y = n)) +
  labs(
       title = "Top 15 downloaded packages on 2019-10-01") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  axis.text.x = element_text(angle = 55, hjust = 1))
```


```{r compareby2year}
# display the daily top 15 popular packages on 10-01 of each year from 2012 to 2019
#g1 <- ggplotGrob(p1)
g2 <- ggplotGrob(p2)
#g12 <- rbind(g1, g2, size = "first")
#g12$widths <- unit.pmax(g1$widths, g2$widths)
grid.newpage()
grid.draw(g2)

g3 <- ggplotGrob(p3)
g4 <- ggplotGrob(p4)
g34 <- rbind(g3, g4, size = "first")
g34$widths <- unit.pmax(g3$widths, g4$widths)
grid.newpage()
grid.draw(g34)

g5 <- ggplotGrob(p5)
g6 <- ggplotGrob(p6)
g56 <- rbind(g5, g6, size = "first")
g56$widths <- unit.pmax(g5$widths, g6$widths)
grid.newpage()
grid.draw(g56)

g7 <- ggplotGrob(p7)
g8 <- ggplotGrob(p8)
g78 <- rbind(g7, g8, size = "first")
g78$widths <- unit.pmax(g7$widths, g8$widths)
grid.newpage()
grid.draw(g78)
```

## Compare last half year's downloads with the release date

In our common cognition, we think that the earlier a package is released, the more people will know about it, and thus the more downloads it will have. However, packages related to different topics cannot be directly compared, because it is possible that the total download amount of packages in a certain topic is higher than that in another topic. Therefore, in order to test this conjecture as clearly as possible, I selected three domain packages through CRAN task view, calculated their respective downloads in the previous two years, and found their release dates for comparison.

1. Packages for Time Series Analysis


```{r get-arcvreleasedate}

# function used to get archive release dates from CRAN
get_arcvupdate_date <- function(packages){
  pkg_url <- "https://cran.r-project.org/web/packages/{pkg}/index.html"
  pkg_archive <- "https://cran.r-project.org/src/contrib/Archive/{pkg}/"
  pkg_updates <- map(packages, function(pkg) {
      
    archive_dates <- tryCatch({ 
        read_html(glue(pkg_archive)) %>% 
          html_table() %>%
          .[[1]] %>% 
          pull(`Last modified`) %>% 
          ymd_hm() %>% 
          na.omit() %>% 
          as.Date()
      }, error = function(e) {
        NULL
      })
    archive_dates
  })
names(pkg_updates) <- packages

updates <- unlist(pkg_updates) %>% 
  enframe("package", "update") %>% 
  # unlist converts date to integers
  mutate(update = as.Date(update, origin = "1970-01-01"),
         # need to get rid of the numbers appended to pkg names
         package = str_extract(package, paste0(packages, collapse="|"))) 

return(updates)
}


```


```{r getpkg}
# the packages for econometrics
Econometrics <- read.ctv(system.file("ctv", "Econometrics.ctv", package = "ctv")) 

Econometrics <- list(Econometrics)

Econometrics <- lapply(Econometrics, '[', 8) %>%
  as.data.frame() 

Econometrics <- Econometrics %>%
  rename(package = packagelist.name) %>%
  filter_list() %>%
  filter(packagelist.core == "FALSE")%>%
  select(-packagelist.core)


# the packages for time series
TimeSeries <- read.ctv(system.file("ctv", "TimeSeries.ctv", package = "ctv")) 

TimeSeries <- list(TimeSeries)

TimeSeries <- lapply(TimeSeries, '[', 8) %>%
  as.data.frame() 

TimeSeries <- TimeSeries %>%
  rename(package = packagelist.name) %>%
  filter_list() %>%
  filter(packagelist.core == "FALSE")%>%
  select(-packagelist.core)

# the packages for bayesian
Bayesian <- read.ctv(system.file("ctv", "Bayesian.ctv", package = "ctv")) 

Bayesian <- list(Bayesian)

Bayesian <- lapply(Bayesian, '[', 8) %>%
  as.data.frame() 

Bayesian <- Bayesian %>%
  rename(package = packagelist.name) %>%
  filter_list() %>%
  filter(packagelist.core == "FALSE")%>%
  select(-packagelist.core)

```


```{r eco-updates}
packages <- c("intReg","ivbma","ivlewbel","MSBVAR","PANICr","phtt","rddapp","rddtools","rUnemploymentData","SemiParSampleSel","tsfa")

earliest_updates <- function(packages){
  
  earliest_updates <- get_arcvupdate_date(packages) %>%
  group_by(package) %>%
  arrange(update, .by_group = TRUE) %>% #arrange within group
  top_n(-1, update) # to get the earliest release date
  
  return(earliest_updates)
}

econometric_realease <- earliest_updates(packages) 

econometric_realease %>%
  kable(caption = "Packages of Econometric from CRAN task view with earliest release date") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))

```


```{r timeseris-updates}
packages <- c("autovarCore","brainwaver","cents","CommonTrend","cts","dlmodeler","FGN","fractal","fractalrock","LSTS","mafs","MAR1","MSBVAR","mvcwt","orderedLasso","pear","rbcb","rdatamarket","sae2","spectral.methods","stsm.class","TED","tsbugs","tsfa","Wats","wmtsa")

earliest_updates <- function(packages){
  
  earliest_updates <- get_arcvupdate_date(packages) %>%
  group_by(package) %>%
  arrange(update, .by_group = TRUE) %>% #arrange within group
  top_n(-1, update) # to get the earliest release date
  
  return(earliest_updates)
}

timeseris_realease <- earliest_updates(packages) 

timeseris_realease %>%
  kable(caption = "Packages of Timeseries from CRAN task view with earliest release date") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

```{r bayesian-updates}
packages <- c("abn","AtelieR","BayesSummaryStatLM","Bayesthresh","bclust","bisoreg","BSquare","BVS","cudaBayesreg","eco","geoRglm","glmmBUGS","MSBVAR","PAWL","profdpm","rbugs","RJaCGH")

earliest_updates <- function(packages){
  
  earliest_updates <- get_arcvupdate_date(packages) %>%
  group_by(package) %>%
  arrange(update, .by_group = TRUE) %>% #arrange within group
  top_n(-1, update) # to get the earliest release date
  
  return(earliest_updates)
}

bayesian_realease <- earliest_updates(packages)

bayesian_realease %>%
  kable(caption = "Packages of Bayesian from CRAN task view with earliest release date") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

It can be seen from Figure \@ref(fig:timeseries) that the most downloaded package for the past six months is `wmtsa` whose release date is 2007-09-06, a relatively early date. And the second downloaded one is `fractal` released on the same day.

And we could see that `pear`, `tsfa`, `fractalrock` and `CommonTrend` have similar downloads that are higher than the rest of the packages. However, some of them were released before 2010 and some after 2010, showing no obvious time difference.

```{r timeseries, fig.align = 'center', fig.cap="The older package 'fable' has less download count than that of package 'forecast'."}

date1 <- "2019-10-01"
date2 <- "2020-04-01"

get_total_downloads <- function(pkg,date1,date2){
  
  pkg <- cran_downloads(package = paste0(pkg), from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
  
}

timeseries <- rbind(get_total_downloads("autovarCore",date1,date2),get_total_downloads("brainwaver",date1, date2),get_total_downloads("cents",date1,date2),get_total_downloads("CommonTrend",date1, date2),get_total_downloads("cts",date1, date2),get_total_downloads("dlmodeler",date1, date2),get_total_downloads("FGN",date1,date2),get_total_downloads("fractal",date1,date2),get_total_downloads("LSTS",date1, date2),get_total_downloads("mafs",date1, date2),get_total_downloads("MAR1",date1, date2),get_total_downloads("MSBVAR",date1, date2),get_total_downloads("mvcwt",date1, date2),get_total_downloads("pear",date1, date2),get_total_downloads("rbcb",date1, date2),get_total_downloads("sae2",date1, date2),get_total_downloads("stsm.class",date1, date2),get_total_downloads("TED",date1, date2),get_total_downloads("tsbugs",date1, date2),get_total_downloads("tsfa",date1, date2),get_total_downloads("Wats",date1, date2),get_total_downloads("wmtsa",date1, date2)) %>%
  group_by(package) %>%
  as.data.frame()


timeseries <- cbind(timeseries,timeseris_realease) %>%
  .[,-3] %>%
  select(package, count, update)


timeseries %>%
  ggplot(aes(x = update, y = count,colour = package)) +
  geom_point() +
    labs( y = 'Download count',
    title = "Last half year's downloads with the release date",
    subtitle = "between for time series packages") +
  scale_y_sqrt() + # to change the scale of y axis
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1))
```

2. Bayesian packages for general model fitting

Let's have a look at the bayesian packages. It can be seen from Figure \@ref(fig:bayesian) that the most downloaded packages is `geoRglm` released on 2002-02-13. Then package `profdpm` released on 2009-11-15 and `abn` released on 2011-07-26 are also highly downloaded, which come from the relatively recent date. Then the difference in the downloads of other packages is not very significant.

Therefore, in this type of packages, we can say that the later the release date, the lower the download volume of the package. But there are still some special cases. That is even if the release date is later, the download volume is still not ideal such as `growcurves`,  which may be due to other reasons.

```{r bayesian,fig.align = 'center', fig.cap="last two years' downloads with the release date for bayesian general model fitting packages."}

timeseries <- rbind(get_total_downloads("abn",date1,date2),get_total_downloads("AtelieR",date1, date2),get_total_downloads("BayesSummaryStatLM",date1,date2),get_total_downloads("CommonTrend",date1, date2),get_total_downloads("cts",date1, date2),get_total_downloads("dlmodeler",date1, date2),get_total_downloads("FGN",date1,date2),get_total_downloads("fractal",date1,date2),get_total_downloads("LSTS",date1, date2),get_total_downloads("mafs",date1, date2),get_total_downloads("MAR1",date1, date2),get_total_downloads("MSBVAR",date1, date2),get_total_downloads("mvcwt",date1, date2),get_total_downloads("pear",date1, date2),get_total_downloads("rbcb",date1, date2),get_total_downloads("sae2",date1, date2),get_total_downloads("stsm.class",date1, date2),get_total_downloads("TED",date1, date2),get_total_downloads("tsbugs",date1, date2),get_total_downloads("tsfa",date1, date2),get_total_downloads("Wats",date1, date2),get_total_downloads("wmtsa",date1, date2)) %>%
  group_by(package) %>%
  as.data.frame()


timeseries <- cbind(timeseries,timeseris_realease) %>%
  .[,-3] %>%
  select(package, count, update)


timeseries %>%
  ggplot(aes(x = update, y = count,colour = package)) +
  geom_point() +
    labs( y = 'Download count',
    title = "Last half year's downloads with the release date",
    subtitle = "between for time series packages") +
  scale_y_sqrt() + # to change the scale of y axis
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1))


bayesian7 %>%
  ggplot(aes(x = release_date, y = count,fill = package)) +
  geom_bar(stat = "identity") +
    labs( y = 'Download count',
          x = 'Relsease date',
    title = "Last two years' downloads with the release date",
    subtitle = "for bayesian packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1)) 

```

3. Econometrics for basic linear regression

In order to test whether this is the case in other areas, let's turn our attention to econometrics packages. 

It can be seen from Figure \@ref(fig:eco-lm) that the second oldest package `tsfa` has the highest downloads, while the downloads of `rddtools` with the second earliest release date is much close to it.

This is quite different to Bayesian's case, that is, although the most downloaded package comes from early date, the second downloaded package comes from newer date, and the overall download volume of packages released after 2013 is higher.

Therefore, in this case, except for the package with the highest download, the packages with the later release date are more likely to have higher downloads.

```{r eco-lm,fig.align = 'center', fig.cap="The latest package sandwich has the highest downloads."}
MSBVAR <- cran_downloads(package = "MSBVAR", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

tsfa <- cran_downloads(package = "tsfa", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

SemiParSampleSel <- cran_downloads(package = "SemiParSampleSel", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

intReg <- cran_downloads(package = "intReg", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

rUnemploymentData <- cran_downloads(package = "rUnemploymentData", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
	
rddapp <- cran_downloads(package = "rddapp", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
	
PANICr <- cran_downloads(package = "PANICr", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

phtt  <- cran_downloads(package = "phtt", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

rddtools  <- cran_downloads(package = "rddtools", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

ivbma  <- cran_downloads(package = "ivbma", from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)

eco_lm <- rbind(MSBVAR,tsfa,SemiParSampleSel,intReg,rUnemploymentData,rddapp,PANICr,phtt,rddtools,ivbma) %>%
  group_by(package) 

eco_lm <- as.data.frame(eco_lm)

release_date <- c("2005-09-20","2006-02-11","2012-04-30","2012-01-12","2015-01-04","2017-12-12","2014-10-24","2013-02-25","2015-07-27","2012-02-29")

eco_lm <- cbind(eco_lm,release_date) 

eco_lm %>%
  ggplot(aes(x = release_date, y = count,fill = package)) +
  geom_bar(stat = "identity") +
    labs( y = 'Download count',
          x = 'Relsease date',
    title = "Last half year's downloads with the release date",
    subtitle = "for econometrics packages") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1)) 

```


In conclusion, I'm surprised to find it's not that the earlier the package is released, the more downloads it has. And the most downloaded packages are often from the earlier date, which is reflected in bayesian, econometrics, time series. But packages from later date also have quite high downloads, and for econometrics packages, it shows that the later the release date, the higher the downloads.

## compare packages with similar release date

I would like to compare packages released on the same date (i.e. April 1st, 2021), so I compare the daily downloads of these packages for 04-02.

By looking into Figure \@ref(fig:pkg0401), we could know that the most downloaded package released on 04-01 is `datetimeutils`, and the second one is `berryFunctions`.

```{r}
# Store web url
#crandate <- read_html("https://cran.r-project.org/web/packages/available_packages_by_date.html")

#Scrape the website for the movie rating

#date <- crandate %>% 
  #html_nodes("tr:nth-child(2) td:nth-child(1)") %>%
  #html_text() 

#package <- crandate %>% 
  #html_nodes("tr:nth-child(2) a") %>%
  #html_text()

#pkg_similar_date <- data.frame(date, package)
```

```{r pkg0401, fig.align = 'center', fig.cap="The highest downloaded package 'proxy' is released on 2021-03-05."}

package_0401 <- c("backbone","bbdetection","berryFunctions","bootImpute","ChineseNames","chromoMap","cocktailApp","datetimeutils","deepdive","diversityForest","DLMtool","ecb","EValue","fungible","GetDFPData","gh","insight","LAWBL","mapping","marqLevAlg","microbial","mockcpp","mrbayes","muhaz","NetOrigin","NMOF","PDE","ProcData","PSweight","rbiorxiv","relevance","remotes","rmcorr","samc","scam","sigminer","sisireg","smcfcs","textutils","tsBSS") %>%
  as.data.frame() 
  

package_0401 <- package_0401 %>%
     filter(!(package_0401 %in% pkg_20maintainer$package)) %>%
     filter(!(package_0401 %in% pkg_secondary$package)) %>%
     filter(!(package_0401 %in% pkg_rstusio$package)) %>%
     filter(!(package_0401 %in% pkg_core$package)) %>%
     filter(!(package_0401 %in% pkg_r_related$package))
     head(15)

backbone <- cran_downloads(package = "backbone")
bbdetection <- cran_downloads(package = "bbdetection")
berryFunctions <- cran_downloads(package = "berryFunctions")
bootImpute <- cran_downloads(package = "bootImpute")
chromoMap <- cran_downloads(package = "chromoMap")
cocktailApp <- cran_downloads(package = "cocktailApp")
datetimeutils <- cran_downloads(package = "datetimeutils")
deepdive <- cran_downloads(package = "deepdive")
diversityForest <- cran_downloads(package = "diversityForest")
DLMtool <- cran_downloads(package = "DLMtool")
ecb <- cran_downloads(package = "ecb")
fungible <- cran_downloads(package = "fungible")
GetDFPData <- cran_downloads(package = "GetDFPData")

package_0401 <- rbind(backbone,bbdetection,berryFunctions,bootImpute,chromoMap,cocktailApp,datetimeutils,deepdive,diversityForest,DLMtool,ecb,fungible,GetDFPData) %>%
  group_by(package)

package_0401 %>%
  ggplot(aes(x = package, y = count)) +
  geom_bar(stat = "identity") +
    labs( y = 'Package',
          x = 'Download count',
    title = "The daily downloads of packages released on 04-01",
    subtitle = "on 04-02") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5),
  axis.text.x = element_text(angle = 55, hjust = 1)) 
```


## Compare moving average of fable and forecast

Let's have a look at package `fable` and `forecast`. They are two closely related packages, for `fable` is the recently released tidy version of `forecast`. It can be seen from Figure \@ref(fig:daily-fbl) and Figure \@ref(fig:daily-fcst) that the time series plots of them both show strong weekly seasonality, which means the downloads tend to be higher in week days and thus lower on weekends. 

In order to estimate the trend-cycle and how do they change over time, I consider the weighed 7 moving average. That is, it calculates the weighted average for every seven consecutive time series with the following weights : [1/15,2/15,1/5,1/5,1/5,2/15,1/15]. And this will reduce the weight of weekends with low download volume, and the weight of weekdays with high download volume will be higher, which will reduce the seasonality as much as possible.

```{r}
purrr::map_dr()
```


```{r trans-ff}
# transform the daily download of 'fable' to time series table
fable <- cran_downloads(package = "fable")
forecast <- cran_downloads(package = "forecast")

fable <- fable %>%
  fpp3::as_tsibble(index = date) 

forecast <- forecast %>%
  fpp3::as_tsibble(index = date) 
```

```{r daily-fbl, fig.align = 'center', fig.cap="Fable's daily downloads shows a seasonal pattern."}
fable %>%
  autoplot(count) +
   labs( y = 'Daily download count',
          x = 'Date',
    title = "The daily downloads of fable",
    subtitle = "from 2021-02-06 to 2021-04-02") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 
  
```


```{r  daily-fcst, fig.align = 'center', fig.cap="Fable's daily downloads shows a seasonal pattern."}
forecast %>%
  autoplot(count) +
   labs(  y = 'Daily download count',
          x = 'Date',
    title = "The daily downloads of forecast",
    subtitle = "from 2021-02-06 to 2021-04-02") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 
```


Figure \@ref(fig:ff-ma) shows that in addition to `forecast`'s download volume is much higher than `fable`'s, the two of them have a very similar moving average pattern. But the change of `fable` is more stable than `forecast`, which shows that `fable` is more trending than `forecast` during this period of time.

```{r ff-ma, fig.align = 'center', fig.cap="fable grew significantly before March 1."}
# use 3x5 MA can get a weighed 7 MA of [1/15,2/15,1/5,1/5,1/5,2/15,1/15]
fable_ma <- fable %>%
  mutate(
    `7-MA` = slider::slide_dbl(count, mean,
                .before = 3, .after = 3, .complete = TRUE)
    )

colors <- c('fable' = '#D55E00', 'forecast' = 'violetred4')

p_fbl <- fable_ma %>%
  autoplot(count, color = "gray") +
  geom_line(aes(y = `7-MA`,colour = 'fable')) +
  labs( 
  title = "Weighed moving average of fable and forecast",
  subtitle = "from 2021-02-06 to 2021-04-02") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title.x=element_blank(),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 



forecast_ma <- forecast %>%
  mutate(
    `7-MA` = slider::slide_dbl(count, mean,
                .before = 3, .after = 3, .complete = TRUE)
    )

p_fcst <- forecast_ma %>%
  autoplot(count, color = "gray") +
  geom_line(aes(y = `7-MA`,colour = 'forecast')) +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) 


g_fbl <- ggplotGrob(p_fbl)
g_fcst <- ggplotGrob(p_fcst)
gff <- rbind(g_fbl, g_fcst, size = "first")
gff$widths <- unit.pmax(g_fbl$widths, g_fcst$widths)
grid.newpage()
grid.draw(gff)

```



## compare package score with the number of commits on master branch

Table \@ref(tab:pct-lowupdates) shows the top 15 trending packages these days. I will compare the number of updates of them with their package scores.

```{r trending-commits}
# to find the 100 trending packages before 4.11 and save as csv file

#pkg_trending <- cran_trending() 

#write_csv(pkg_trending,"data/pkg_trending.csv")

# read top 20 trending packages
pkg_trending <- read_csv("data/pkg_trending.csv") 

pkg_trending_19 <- pkg_trending %>%
  head(19)
 
```

```{r  trending-commits1}
# exclude the package 'proxy', 'uplift' , 'ClickClust' and 'spatstat.geom' that only have read-only mirror of the CRAN github repo, and the remaining are 15
pkg_trending_filter <- pkg_trending_19 %>%
  filter(!(package == "proxy")) %>%
  filter(!(package == "uplift")) %>%
  filter(!(package == "spatstat.geom")) %>%
  filter(!(package == "ClickClust"))

# read url of selected trending packages
AzureStor <- GET("https://api.github.com/repos/cloudyr/AzureStor/commits?per_page=1")
AzureRMR  <- GET("https://api.github.com/repos/Azure/AzureRMR/commits?per_page=1")
clickstream  <- GET("https://api.github.com/repos/cran/clickstream/commits?per_page=1")
gRc  <- GET("https://api.github.com/repos/cran/gRc/commits?per_page=1")
fddm  <- GET("https://api.github.com/repos/rtdists/fddm/commits?per_page=1")
js  <- GET("https://api.github.com/repos/jeroen/js/commits?per_page=1")
spatstat.sparse  <- GET("https://api.github.com/repos/spatstat/spatstat.sparse/commits?per_page=1")
spatstat.core  <- GET("https://api.github.com/repos/spatstat/spatstat.core/commits?per_page=1")

spatstat.linnet  <- GET("https://api.github.com/repos/baddstats/spatstat.linnet/commits?per_page=1")
webfakes  <- GET("https://api.github.com/repos/r-lib/webfakes/commits?per_page=1")
tree.interpreter  <-GET("https://api.github.com/repos/nalzok/tree.interpreter/commits?per_page=1")
geospark  <- GET("https://api.github.com/repos/harryprince/geospark/commits?per_page=1")
DMwR2  <-  GET("https://api.github.com/repos/ltorgo/DMwR2/commits?per_page=1")
botor  <-  GET("https://api.github.com/repos/daroczig/botor/commits?per_page=1")
sunburstR  <-  GET("https://api.github.com/repos/timelyportfolio/sunburstR/commits?per_page=1")


# function used to extract commits from github page
get_commits <- function(a) {
  
headers(a)$link

c <- str_split(headers(a)$link, ",") %>%
  unlist()


d <- c[str_detect(c,'rel=\"last\"')] 


f <- str_sub(d, str_locate(d, '&page=')[2]+1, str_locate(d, '>')[1]-1)

return(f)
  
}

commits <- c(get_commits(fddm),get_commits(gRc),get_commits(webfakes),get_commits(tree.interpreter),get_commits(geospark),get_commits(AzureStor),get_commits(spatstat.core),get_commits(AzureRMR),get_commits(spatstat.linnet),get_commits(clickstream),get_commits(js),get_commits(spatstat.sparse),get_commits(DMwR2),get_commits(botor),get_commits(sunburstR))


  
pkg_trending_commits <- cbind(pkg_trending_filter,commits)

```

```{r commits-tbl}
pkg_trending_commits %>%
  kable(caption = "15 Trending package with commits on Github") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```

```{r commits-pattern, fig.align = 'center', fig.cap= "The package with most updates is fddm while the most trending one is fddm."}
pkg_trending_commits %>%
  mutate(score = as.numeric(score)) %>%
  mutate(commits = as.numeric(commits)) %>%
  ggplot(aes(x = commits, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
          x = 'The number of commits',
    title = "Commits counts against the package score",
    subtitle = "for trending packages") +
    annotate("text",y= 1300,x= 120,label="'fddm' with the highest score has 319 commits",color="red") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

```


## compare package score with the number of updates for top 15 trending package


```{r top15-updates}
pkg_trending_15 <- pkg_trending %>%
  head(15)

# find the updates of top 15 trending packages manually
updates <- c("5","13","2","2","2","2","28","2","17","3","16","3","15","5","5") 

pkg_trending_updates <- cbind(pkg_trending_15,updates)
```

Figure \@ref(fig:trend-updates) shows that the package with most updates is 'proxy" while the most trending one is 'fddm'. And the score of top 3 updated packages are all not very high among this group. Another interesting thing is that the updates of package `webfakes`, `tree.interpreter`, `geospark`, `uplift` and `spatstat.geom` are 2, but their scores can vary from `r pkg_trending_updates$score[15]` to `r pkg_trending_updates$score[11]`.

```{r  trend-updates, fig.align = 'center', fig.cap=" The package with most updates is proxy while the most trending one is fddm."}
pkg_trending_updates <- pkg_trending_updates %>%
  mutate(score = as.numeric(score)) %>%
  mutate(updates = as.numeric(updates)) %>%
  arrange(desc(updates))

pkg_trending_updates %>%
  ggplot(aes(x = reorder(score, updates), y = updates)) +
  geom_bar(position = "dodge",stat="identity",fill = '#619CFF') +
  geom_text(aes(label= package) , position=position_dodge(width=1),hjust = 0.000001) +
    labs( y = 'The number of updates',
          x = 'Score',
    title = "Package score against the update count",
    subtitle = "for trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) +
  coord_flip()
```

Furthermore, by looking into Figure \@ref(fig:updates-pattern), it can be found that the score of the package increases with the increase of the number of updates, and then decreases.

Also checking Table \@ref(tab:pct-lowupdates), we can know that the percentage of trending packages whose updates are less than average is `r pct_trending_updates[2][1]`, which means more than half of the top 15 trending packages do not tend to update that frequently. This also explains why they are trending packages, because when the number of updates is too large, the score of packages will decrease.


```{r  pct-lowupdates}
# compute the percentage of top 15 trending packages lying in the low-updated range

avg_updates <- mean(as.numeric(pkg_trending_updates$updates))

pkg_trending_total <- 15

pct_trending_updates <- pkg_trending_updates %>%
  mutate(updates = as.numeric(updates))  %>%
  filter(updates < avg_updates) %>%
  summarise(`number of packages with low updates` = length(package)) %>%
  mutate(`percentage of packages with low updates` = (`number of packages with low updates`/pkg_trending_total)*100)

pct_trending_updates%>%
  kable(caption = "Percentage of trending packages whose updates are less than average") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```


It can be seen from Figure \@ref(fig:latestpublish) that most top 15 trending packages' latest publish date is after 2021, which indicates that popular packages tend to update by time to keep its activity.

```{r  latestpublish,fig.align = 'center', fig.cap=" Most top 15 trending packages' latest publish date is after 2021."}
pkg_trending_updates_low <- pkg_trending_updates %>%
  filter(updates < avg_updates)

latest_publish <- c("2021-03-05","2021-03-16","2021-02-17","2020-01-30","2021-04-03","2021-04-06","2020-06-03","2016-10-23","2021-03-23","2021-03-28","2021-04-05","2020-02-05","2020-03-02","2014-03-17","2021-03-22")

first_publish <- c("2007-07-09","2018-12-25","2018-12-02","2014-02-28","2007-12-21","2020-07-10","2015-02-15","2014-04-28","2021-01-22","2021-02-05","2020-12-16","2019-10-30","2019-10-04","2014-02-01","2021-01-15")

  
pkg_trending_latest_publish <- cbind(pkg_trending_updates,latest_publish,first_publish) %>%
  mutate(days_diff = as.numeric(difftime(latest_publish ,first_publish, units = c("days")))) %>%
  mutate(updates_perday = updates/days_diff)

pkg_trending_latest_publish %>%
  mutate(latest_publish = ymd(latest_publish)) %>%
  ggplot(aes(latest_publish)) +
  geom_density() +
  labs( 
        x = 'Latest publish date',
    title = "Distribution of latest publish date",
    subtitle = "for top 15 trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```
```{r updates-pattern, fig.align = 'center', fig.cap=" The package with most updates is proxy while the most trending one is fddm."}
pkg_trending_updates %>%
  mutate(score = as.numeric(score)) %>%
  mutate(updates = as.numeric(updates)) %>%
  ggplot(aes(x = updates, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
          x = 'The number of updates',
    title = "Update counts against the package score",
    subtitle = "for trending packages") +
  annotate("text",y= 2200,x= 20,label="'proxy' with the highest score has 5 updates",color="red") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```

```{r daily-updates}
pkg_trending_latest_publish %>%
  ggplot(aes(x = updates_perday, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
          x = 'The number of updates',
    title = "Daily update counts against the package score",
    subtitle = "for trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```


In conclusion, it's not that the more updates the package has, the popular it will be. In the trending package, most of the packages whose updates are lower than the average occupy the majority. Therefore, we can also know that the total number of updates is not very important for the trending package. The important thing is to keep it updated.


## compare the package name length with package score for trending packages

It can be seen that although the patterns of top 15 and last 15 are not the same, they all have one thing in common, that is, when the name length exceeds 8 characters, the package score will drop significantly. And when length is less than 4 characters, the score would not be ideal either.

```{r  namelength-plot}
# also use the top 15 trending packages before 4.11
pkg_trending_15_namelth <- pkg_trending_15 %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 

# to get the last 15 trending ones
pkg_trending_tail15 <- pkg_trending %>%
  tail(15) 

pkg_trending_tail15_namelth <- pkg_trending_tail15 %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 

# to get the name length for all trending packages before 4.11
  pkg_trending1 <- pkg_trending %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 
  
  
pkg_trending_15_namelth %>%
  ggplot(aes(x = length_name, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
        x = 'The length of package names',
    title = "Name length against the package score",
    subtitle = "for top 15 trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))


pkg_trending_tail15_namelth %>%
  ggplot(aes(x = length_name, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
        x = 'The length of package names',
    title = "Name length against the package score",
    subtitle = "for last 15 trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

pkg_trending1 %>%
  ggplot(aes(x = length_name, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
        x = 'The length of package names',
    title = "Name length against the package score",
    subtitle = "for all trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```

```{r namelength}

# function used to get the name length and the percentage of packages whose name length is under total average
avg_namelth <- function(df){
    
  df1 <- df %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 
  
`total average name length` <- mean(pkg_trending1$length_name)
`average name length`  <- mean(df1$length_name)
pkg_trending_total <- length(df1$package)

df2 <- df1 %>%
  filter(length_name < `total average name length`) %>%
  summarise(`number of short names` = length(package)) %>%
  mutate(`percentage of short names` = (`number of short names`/pkg_trending_total)*100)

df2 <- cbind(df2,`average name length`,`total average name length`)

return(df2)
  
}


trending_top15_namelth <- avg_namelth(pkg_trending_15) %>%
  mutate(group = "top 15")

trending_tail15_namelth <- avg_namelth(pkg_trending_tail15) %>%
  mutate(group = "last 15")

trending_all_namelth <- avg_namelth(pkg_trending) %>%
  mutate(group = "all")

compare_trending_namelth <- rbind(trending_top15_namelth,trending_tail15_namelth,trending_all_namelth)
```

Table \@ref(tab:pct-lngname) shows that the average name length of last 15 packages is more close to the total average. And over half of the packages are more likely to have names longer than average for both top 15 and last 15, but this is more significant among top 15. That means top trending packages are more likely to have longer names.

```{r pct-lngname}
compare_trending_namelth %>%
  kable(caption = "Percentage of trending packages whose updates are less than average") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

```{r compute-ci}
# to get the 95% CI of the name length

# calculate the mean, sd and se
sample.mean <- mean(pkg_trending1$length_name)
sample.n <- length(pkg_trending1$length_name)
sample.sd <- sd(pkg_trending1$length_name)
sample.se <- sample.sd/sqrt(sample.n)

# find t-score
alpha <- 0.05
degrees.freedom <- sample.n - 1
t.score <- qt(p=alpha/2, df=degrees.freedom,lower.tail=F)

margin.error <- t.score * sample.se

# get the 95% CI
lower.bound <- sample.mean - margin.error
upper.bound <- sample.mean + margin.error

namelth_CI <- cbind(lower.bound,upper.bound)

```

Table \@ref(tab:pct-lngname) shows the 95% confidence interval of name length for trending packages. We could know that the 95% suitable name length is between 7 and 9 characters.

```{r namelth-ci}
namelth_CI %>%
  kable(caption = "95% Confidence Interval of name length for trending packages") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

