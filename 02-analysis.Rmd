# Analysis

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(pkgsearch)
library(jsonlite)
library(grid)
library(cranlogs)
library(ctv)
library(lubridate)
library(rvest)
library(htmltools)
#install.packages("jsonlite")
library(jsonlite)
#install.packages("httpuv")
library(httpuv)
#install.packages("httr")
library(httr)
library(ctv)
library(purrr)
library(kableExtra)
library(packageRank)
library(fpp3)
library(slider)
library(stringr)
library(lubridate)
library(dplyr)
library(rvest)
library(glue)
library(plyr)
```

## Daily top 15 downloaded packages 

```{r readcran}
url <- "http://cran.rstudio.com/web/packages/packages.rds"
db <- readRDS(url(url)) %>% 
as.data.frame()

#cran2012_10_01 <- read_csv("data/2012-10-01 (1).csv")
#cran2013_10_01 <- read_csv("data/2013-10-01.csv")
#cran2014_10_01 <- read_csv("data/2014-10-01.csv")
#cran2015_10_01 <- read_csv("data/2015-10-01.csv")
#cran2016_10_01 <- read_csv("data/2016-10-01.csv")
#cran2017_10_01 <- read_csv("data/2017-10-01.csv")
#cran2018_10_01 <- read_csv("data/2018-10-01.csv")
#cran2019_10_01 <- read_csv("data/2019-10-01.csv")

#save(cran2012_10_01, file=here::here("data/cran2012_10_01.rda"))
#save(cran2013_10_01, file=here::here("data/cran2013_10_01.rda"))
#save(cran2014_10_01, file=here::here("data/cran2014_10_01.rda"))
#save(cran2015_10_01, file=here::here("data/cran2015_10_01.rda"))
#save(cran2016_10_01, file=here::here("data/cran2016_10_01.rda"))
#save(cran2017_10_01, file=here::here("data/cran2017_10_01.rda"))
#save(cran2018_10_01, file=here::here("data/cran2018_10_01.rda"))
#save(cran2019_10_01, file=here::here("data/cran2019_10_01.rda"))

load("data/cran2012_10_01.rda")
load("data/cran2013_10_01.rda")
load("data/cran2014_10_01.rda")
load("data/cran2015_10_01.rda")
load("data/cran2016_10_01.rda")
load("data/cran2017_10_01.rda")
load("data/cran2018_10_01.rda")
load("data/cran2019_10_01.rda")
```

```{r filter-list}
# filter the packages maintained by R studio
pkg_rstusio <- db %>%
  filter(grepl('RStudio', Author)) %>%
  select(Package) %>%
  rename(package = Package)


# filter the packages whose author is from R core group
pkg_core <- db %>%
  filter(grepl('Douglas Bates|John Chambers|Peter Dalgaard|Robert Gentleman|Kurt Hornik|Ross Ihaka|Tomas Kalibera|Michael Lawrence|Friedrich Leisch|Uwe Ligges|Thomas Lumley|Martin Maechler|Martin Morgan|Paul Murrell|Brian Ripley|Deepayan Sarkar|Duncan Temple Lang|Luke Tierney|Simon Urbanek|Martyn Plummer|', Author))

pkg_secondary <- db %>%
  filter(!grepl('Guido Masarotto|Duncan Murdoch|Henrik Bengtsson|Roger Bivand|Ben Bolker|David Brahm|Vince Carey|Saikat DebRoy|Matt Dowle|Dirk Eddelbuettel|Claus Ekstrom|John Fox|Paul Gilbert|Yu Gong|Gabor Grothendieck|Frank E Harrell Jr|Peter M. Haverty|Torsten Hothorn|Robert King|Kjetil Kjernsmo|Roger Koenker|Philippe Lambert|Jan de Leeuw|Jim Lindsey|Patrick Lindsey|Catherine Loader| Gordon Maclean|Arni Magnusson|John Maindonald|David Meyer|Ei-ji Nakama|Jens Oehlschägel|Steve Oncley|Richard O’Keefe|Hubert Palme|Roger D. Peng|José C. Pinheiro|Tony Plate|Anthony Rossini| Jonathan Rougier|Petr Savicky|Günther Sawitzki|Marc Schwartz|Arun Srinivasan|Detlef Steuer|Bill Simpson|Gordon Smyth|Adrian Trapletti|Terry Therneau|Rolf Turner|Bill Venables|Gregory R. Warnes| Andreas Weingessel|Morten Welinder|James Wettenhall|Simon Wood|and Achim Zeileis', Author)) %>%
  select(Package) %>%
  rename(package = Package)


# filter the packages developed by top 20 prolific maintainers
pkg_20maintainer <- db %>% 
  filter(stringr::str_detect(Author, 'Hadley Wickham|Yihui Xie|Dirk Eddelbuettel|Jeroen Ooms|Achim Zeileis|Scott Chamberlain|Gabor Csardi|Jeroen Ooms|ORPHANED|Thomas J. Leeper|Bob Rudis|Henrik Bengtsson|Kurt Hornik|Oliver Keyes|Martin Maechler|Richard Cotton|Robin K. S. Hankin|Simon Urbanek|Kirill Muller|Torsten Hothorn|Paul Gilbert') )%>%
  select(Package) %>%
  rename(package = Package)


# filter the packages developed by other R studio related authors
pkg_r_related <- db %>%
  filter(stringr::str_detect(Author, 'Hadley Wickham|Yihui Xie|Gabor Csardi|Winston Chang|Andrie de Vries|Alison Presmanes Hill|Mara Averick|Cole Arendt|Daniel Falbel|Garrick Aden-Buie|Garrett Grolemund|Gary|Joe Cheng|Jennifer (Jenny) Bryan|Jim Hester|J.J. Allaire|Jonathan|Joshua Spiewak|Dan Buch|Richard Iannone|Ralf Stubner|Tyler Finethy|Melissa Barca|Kevin Ushey|Javier Luraschi|Karl Feinauer|Charles Teague|Maria Semple|adamconroy|Ricardo Andrade|Steve Nolen|Randy Lai|Jeffrey Horner|Jan Marvin Garbuszus|Justace Clutter|Josh Paulson|Mike Bessuille|Jeffrey Arnold|Paul Kaefer|Jim Hester|Dirk Schumacher|
Philipp A.|Fabian Mundt|Fabian Mundt|boB Rudis|Asher|Henrik Bengtsson|James Lamb|rich-rstudio|Andrie de Vries|Iñaki Ucar|Mark Brown|Hiroaki Yutani|Dean Attali|Matthias Mailänder|Bruno Tremblay|Ian|John Blischak|Chris von Csefalvay|Jeroen Ooms|
Daniel Gromer|Kirill Müller|Jan Gleixner|Alexander Grueneberg|Darío Hereñú|Aron Atkins|harupiko|Barret Schloerke|James Arnold|Giuseppe Casalicchio|Fredric Johansson|Curtis Kephart|reudismam|Jeff Allen|Yuri Niyazov|Sean Kross|Carl A. B. Pearson|
Peter Glerup Ericson|Diomidis Spinellis|Paul Menzel|Lincoln Mullen|Colin Gillespie|Masafumi Okada|Øystein Sørensen|Matthew Grogan|Scott Kostyshak|Marcus Kinsella|rhinopotamus|Daiki Katsuragawa|Michael Steinbaugh|Jari Karppinen|Roy Storey|Kristofer Rye|Erin|Ben Torvaney|Pol Mesalles|Sainath Adapa|Vladimir Panfilov|Christian Brueffer|Julien Barnier|') )%>%
  select(Package) %>%
  rename(package = Package)

```


```{r filter-function}
# function used to do filtering
filter_list <- function(pkg){
  
  pkg <- pkg %>%
     filter(!(package %in% pkg_20maintainer$package)) %>%
     filter(!(package %in% pkg_secondary$package)) %>%
     filter(!(package %in% pkg_rstusio$package)) %>%
     filter(!(package %in% pkg_core$package)) %>%
     filter(!(package %in% pkg_r_related$package))
  
  return(pkg)
}
```


```{r filterlist}
# exclude the packages in the above three lists
cran2019_10_01_new <- filter_list(cran2019_10_01)
cran2018_10_01_new <- filter_list(cran2018_10_01)
cran2017_10_01_new <- filter_list(cran2017_10_01)
cran2016_10_01_new <- filter_list(cran2016_10_01)
cran2015_10_01_new <- filter_list(cran2015_10_01)
cran2014_10_01_new <- filter_list(cran2014_10_01)
cran2013_10_01_new <- filter_list(cran2013_10_01)
```


```{r crantop15-1319}
# find the top 30 downloaded packages on 10.1 from 2013 to 2019
cran2013_1001 <- cran2013_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  select(package)
  
#cran2013_1001$package <- as.vector(cran2013_1001$package) #get rid of factors

#cran2013_1001$package = factor(cran2013_1001$package,cran2013_1001$package)

cran2014_1001 <- cran2014_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  select(package)

cran2015_1001 <- cran2015_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  select(package)

cran2016_1001 <- cran2016_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  select(package)

cran2017_1001 <- cran2017_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  select(package)

cran2018_1001 <- cran2018_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  select(package)

cran2019_1001 <- cran2019_10_01_new %>%
  drop_na() %>%
  count(package) %>%
  arrange(desc(n)) %>%
  head(15) %>%
  select(package)

```


```{r antijoin-1319}
# find out the new top 15 packages added each year
a <- anti_join(cran2014_1001,cran2013_1001) 
b <- anti_join(cran2015_1001,cran2014_1001) 
c <- anti_join(cran2016_1001,cran2015_1001) 
d <- anti_join(cran2017_1001,cran2016_1001) 
e <- anti_join(cran2018_1001,cran2017_1001) 
f <- anti_join(cran2019_1001,cran2018_1001) 

# function used to combine data with different length 
cbind_dif <- function(x = list()){
    # Find max length
    max_length <- max(unlist(lapply(x, length)))

    # Set length of each vector as
    res <- lapply(x, function(x){
        length(x) <- max_length
        return(x)
    })

    return(as.data.frame(res))
}

pkg_change <- cbind_dif(list(package14_13 = a$package, package15_14 = b$package, package16_15 = c$package, package17_16 = d$package, package18_17 = e$package, package19_18 = f$package))

pkg_change[is.na(pkg_change)] = "-"
```

```{r semijoin-1319}
a1 <- semi_join(cran2014_1001,cran2013_1001) 
b1 <- semi_join(cran2015_1001,cran2014_1001) 
c1 <- semi_join(cran2016_1001,cran2015_1001) 
d1 <- semi_join(cran2017_1001,cran2016_1001) 
e1 <- semi_join(cran2018_1001,cran2017_1001) 
f1 <- semi_join(cran2019_1001,cran2018_1001) 

pkg_remain <- cbind_dif(list(package14_13 = a1$package, package15_14 = b1$package, package16_15 = c1$package, package17_16 = d1$package, package18_17 = e1$package, package19_18 = f1$package))

pkg_remain[is.na(pkg_remain)] = "-"
```

```{r changed-top15pkg}
pkg_change %>%
  kable(caption = "Changed top 15 downloaded packages from 2013 to 2019") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 

```

```{r  unchanged-top15pkg}
pkg_remain %>%
  kable(caption = "Unchanged top 15 downloaded packages from 2013 to 2019") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```

## Compare last half year's downloads with the release date

In our common cognition, we think that the earlier a package is released, the more people will know about it, and thus the more downloads it will have. However, packages related to different topics cannot be directly compared, because it is possible that the total download amount of packages in a certain topic is higher than that in another topic. Therefore, in order to test this conjecture as clearly as possible, I selected three domain packages through CRAN task view, calculated their respective downloads in the previous two years, and found their release dates for comparison.

1. Packages for Time Series Analysis


```{r get-arcvreleasedate}

# function used to get archive release dates from CRAN
get_arcvupdate_date <- function(packages){
  pkg_url <- "https://cran.r-project.org/web/packages/{pkg}/index.html"
  pkg_archive <- "https://cran.r-project.org/src/contrib/Archive/{pkg}/"
  pkg_updates <- map(packages, function(pkg) {
      
    archive_dates <- tryCatch({ 
        read_html(glue(pkg_archive)) %>% 
          html_table() %>%
          .[[1]] %>% 
          pull(`Last modified`) %>% 
          ymd_hm() %>% 
          na.omit() %>% 
          as.Date()
      }, error = function(e) {
        NULL
      })
    archive_dates
  })
names(pkg_updates) <- packages

updates <- unlist(pkg_updates) %>% 
  enframe("package", "update") %>% 
  # unlist converts date to integers
  mutate(update = as.Date(update, origin = "1970-01-01"),
         # need to get rid of the numbers appended to pkg names
         package = str_extract(package, paste0(packages, collapse="|"))) 

return(updates)
}


```


```{r getpkg}

# function used to get packages of  a certain topic from CRAN task view
get_pkg_taskview <- function(topic_file){
  
topic_pkg <- read.ctv(system.file("ctv", paste0(topic_file), package = "ctv")) 

topic_pkg <- list(topic_pkg)

topic_pkg <- lapply(topic_pkg, '[', 8) %>%
  as.data.frame() 

topic_pkg <- topic_pkg %>%
  rename(package = packagelist.name) %>%
  filter_list() %>%
  filter(packagelist.core == "FALSE")%>%
  select(-packagelist.core)
  
}


# get the packages for econometrics
topic_file <- "Econometrics.ctv"
Econometrics <- get_pkg_taskview(topic_file) 



# get the packages for time series
topic_file <- "TimeSeries.ctv"
TimeSeries <- get_pkg_taskview(topic_file)


# get the packages for bayesian
topic_file <- "Bayesian.ctv"
Bayesian <- get_pkg_taskview(topic_file)


```


```{r  function-earliestrelease-counts}

# function used to get the total downloads of a period of time and the eariest release date
downloads_earliest_release <- function(packages) {

# function used to get the earliest release date from CRAN
earliest_updates <- function(packages){
  
  earliest_updates <- get_arcvupdate_date(packages) %>%
  group_by(package) %>%
  arrange(update, .by_group = TRUE) %>% #arrange within group
  top_n(-1, update) # to get the earliest release date, top_n() is used to select the lowest value of a column within each group
  
}

earliest_updates <- earliest_updates(packages)

packages_vector <- earliest_updates$package


# function used to get the total downloads of a period of time (date1 to date2) for several pacckages at the same time
get_total_downloads <- function(packages_vector){
  
total_downloads <- map(packages_vector, function(pkg){
  
  pkg <- cran_downloads(package = paste0(pkg), from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
  
})

 names(total_downloads) <- packages_vector

downloads <- unlist(total_downloads) %>% 
  enframe("package", "count") %>% 
  mutate(count = suppressWarnings(as.numeric(count)),
         # need to get rid of the numbers appended to pkg names
         package = str_extract(package, paste0(packages_vector, collapse="|")))%>%
         na.omit()
}

downloads <- get_total_downloads(packages_vector)
  
downloads_release_earliest <- downloads %>%
  as.data.frame() %>%
  left_join(earliest_updates,by = "package")

return(downloads_release_earliest)

}
```

```{r eco-updates}
# before use the function 'downloads_earliest_release()', please set the time range
date1 <- "2019-10-01"
date2 <- "2020-04-01"

packages <- Econometrics$package 

econometric <- downloads_earliest_release(packages)


econometric %>%
  kable(caption = "Econometrics packages with earliest release date and last half year's total counts") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))

```


```{r timeseris-updates}
packages <- TimeSeries$package 

timeseries <- downloads_earliest_release(packages)


timeseries %>%
  kable(caption = "Timeseries packages with earliest release date and last half year's total counts") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))

```

```{r bayesian-updates}
packages <- Bayesian$package 

bayesian <- downloads_earliest_release(packages)

bayesian%>%
  kable(caption = "Bayesian packages with earliest release date and last half year's total counts") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

It can be seen from Figure \@ref(fig:timeseries) that the most downloaded package for the past six months is `wmtsa` whose release date is 2007-09-06, a relatively early date. And the second downloaded one is `fractal` released on the same day.

And we could see that `pear`, `tsfa`, `fractalrock` and `CommonTrend` have similar downloads that are higher than the rest of the packages. However, some of them were released before 2010 and some after 2010, showing no obvious time difference.

```{r timeseries, fig.align = 'center', fig.cap="The older package 'fable' has less download count than that of package 'forecast'."}

timeseries %>%
  ggplot(aes(x = update, y = count,colour = package)) +
  geom_point() +
    labs( y = 'Download count',
    title = "Last half year's downloads with the earliest release date",
    subtitle = "between for time series packages") +
  scale_y_sqrt() + # to change the scale of y axis
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```

2. Bayesian packages for general model fitting

Let's have a look at the bayesian packages. It can be seen from Figure \@ref(fig:bayesian) that the most downloaded packages is `geoRglm` released on 2002-02-13. Then package `profdpm` released on 2009-11-15 and `abn` released on 2011-07-26 are also highly downloaded, which come from the relatively recent date. Then the difference in the downloads of other packages is not very significant.

Therefore, in this type of packages, we can say that the later the release date, the lower the download volume of the package. But there are still some special cases. That is even if the release date is later, the download volume is still not ideal such as `growcurves`,  which may be due to other reasons.

```{r bayesian,fig.align = 'center', fig.cap="last two years' downloads with the release date for bayesian general model fitting packages."}

bayesian %>%
  ggplot(aes(x = update, y = count,colour = package)) +
  geom_point() +
    labs( y = 'Download count',
    title = "Last half year's downloads with the earliest release date",
    subtitle = "between for bayesian packages") +
  scale_y_sqrt() + # to change the scale of y axis
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

```

3. Econometrics 

In order to test whether this is the case in other areas, let's turn our attention to econometrics packages. 

It can be seen from Figure \@ref(fig:eco-lm) that the second oldest package `tsfa` has the highest downloads, while the downloads of `rddtools` with the second earliest release date is much close to it.

This is quite different to Bayesian's case, that is, although the most downloaded package comes from early date, the second downloaded package comes from newer date, and the overall download volume of packages released after 2013 is higher.

Therefore, in this case, except for the package with the highest download, the packages with the later release date are more likely to have higher downloads.

```{r eco-lm,fig.align = 'center', fig.cap="The latest package sandwich has the highest downloads."}

bayesian %>%
  ggplot(aes(x = update, y = count,colour = package)) +
  geom_point() +
    labs( y = 'Download count',
    title = "Last half year's downloads with the earliest release date",
    subtitle = "between for econometrics packages") +
  scale_y_sqrt() + # to change the scale of y axis
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

```


In conclusion, I'm surprised to find it's not that the earlier the package is released, the more downloads it has. And the most downloaded packages are often from the earlier date, which is reflected in bayesian, econometrics, time series. But packages from later date also have quite high downloads, and for econometrics packages, it shows that the later the release date, the higher the downloads.

## compare packages with similar release date

I would like to compare packages released on the same date (i.e. April 1st, 2021), so I compare the daily downloads of these packages for 04-02.

By looking into Figure \@ref(fig:pkg0401), we could know that the most downloaded package released on 04-01 is `datetimeutils`, and the second one is `berryFunctions`.

```{r}

```


## Compare moving average of fable and forecast

Let's have a look at package `fable` and `forecast`. They are two closely related packages, for `fable` is the recently released tidy version of `forecast`. It can be seen from Figure \@ref(fig:daily-fbl) and Figure \@ref(fig:daily-fcst) that the time series plots of them both show strong weekly seasonality, which means the downloads tend to be higher in week days and thus lower on weekends. 

In order to estimate the trend-cycle and how do they change over time, I consider the weighed 7 moving average. That is, it calculates the weighted average for every seven consecutive time series with the following weights : [1/15,2/15,1/5,1/5,1/5,2/15,1/15]. And this will reduce the weight of weekends with low download volume, and the weight of weekdays with high download volume will be higher, which will reduce the seasonality as much as possible.

```{r}
purrr::map_dr()
```


```{r trans-ff}
# transform the daily download of 'fable' to time series table
fable <- cran_downloads(package = "fable",from = date1, to = date2)
forecast <- cran_downloads(package = "forecast",from = date1, to = date2)

fable <- fable %>%
  as_tsibble(index = date) 

forecast <- forecast %>%
  as_tsibble(index = date) 
```

```{r daily-fbl, fig.align = 'center', fig.cap="Fable's daily downloads shows a seasonal pattern."}
fable %>%
  autoplot(count) +
   labs( y = 'Daily download count',
          x = 'Date',
    title = "The daily downloads of fable",
    subtitle = "from 2021-02-06 to 2021-04-02") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 
  
```


```{r  daily-fcst, fig.align = 'center', fig.cap="Fable's daily downloads shows a seasonal pattern."}
forecast %>%
  autoplot(count) +
   labs(  y = 'Daily download count',
          x = 'Date',
    title = "The daily downloads of forecast",
    subtitle = "from 2021-02-06 to 2021-04-02") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 
```


Figure \@ref(fig:ff-ma) shows that in addition to `forecast`'s download volume is much higher than `fable`'s, the two of them have a very similar moving average pattern. But the change of `fable` is more stable than `forecast`, which shows that `fable` is more trending than `forecast` during this period of time.

```{r ff-ma, fig.align = 'center', fig.cap="fable grew significantly before March 1."}
# use 7 MA can get a equal weighed 7 MA 
fable_ma <- fable %>%
  mutate(
    `7-MA` = slider::slide_dbl(count, mean,
                .before = 3, .after = 3, .complete = TRUE)
    )

colors <- c('fable' = '#D55E00', 'forecast' = 'violetred4')

p_fbl <- fable_ma %>%
  autoplot(count, color = "gray") +
  geom_line(aes(y = `7-MA`,colour = 'fable')) +
  labs( 
  title = "Weighed moving average of fable and forecast",
  subtitle = "from 2021-02-06 to 2021-04-02") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title.x=element_blank(),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 



forecast_ma <- forecast %>%
  mutate(
    `7-MA` = slider::slide_dbl(count, mean,
                .before = 3, .after = 3, .complete = TRUE)
    )

p_fcst <- forecast_ma %>%
  autoplot(count, color = "gray") +
  geom_line(aes(y = `7-MA`,colour = 'forecast')) +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) 


g_fbl <- ggplotGrob(p_fbl)
g_fcst <- ggplotGrob(p_fcst)
gff <- rbind(g_fbl, g_fcst, size = "first")
gff$widths <- unit.pmax(g_fbl$widths, g_fcst$widths)
grid.newpage()
grid.draw(gff)

```



## compare package score with the number of commits on master branch

Table \@ref(tab:pct-lowupdates) shows the top 15 trending packages these days. I will compare the number of updates of them with their package scores.

```{r trending-commits}
# to find the 100 trending packages before 4.11 and save as csv file

#pkg_trending <- cran_trending() 

#write_csv(pkg_trending,"data/pkg_trending.csv")

# read top 49 trending packages
pkg_trending <- read_csv("data/pkg_trending.csv") 

pkg_trending_49 <- pkg_trending %>%
  head(49)
 

# exclude the package that only have read-only mirror of the CRAN github repo, and the remaining are 30
pkg_trending_filter <- pkg_trending_49 %>%
  filter(!(package == "proxy")) %>%
  filter(!(package == "uplift")) %>%
  filter(!(package == "spatstat.geom")) %>%
  filter(!(package == "ClickClust")) %>%
  filter(!(package == "gRc")) %>%
  filter(!(package == "anesrake")) %>%
  filter(!(package == "svd")) %>%
  filter(!(package == "textutils")) %>%
  filter(!(package == "rgl")) %>%
  filter(!(package == "tseries")) %>%
  filter(!(package == "tsDyn")) %>%
  filter(!(package == "tseriesChaos")) %>%
  filter(!(package == "penalized")) %>%
  filter(!(package == "mapdata")) %>%
  filter(!(package == "plot3D")) %>%
  filter(!(package == "ic.infer")) %>%
  filter(!(package == "misc3d")) %>%
  filter(!(package == "textshaping")) %>%
  filter(!(package == "ragg"))

```

```{r function-commits}

# function used to extract commits on master branch on Github
get_commits <- function(username,pkg){

pkg_url <- GET(glue::glue("https://api.github.com/repos/{username}/{pkg}/commits?per_page=1"))

# function used to extract commits from github page
commits <-  function(pkg_url) {
  
headers(pkg_url)$link

c <- str_split(headers(pkg_url)$link, ",") %>%
  unlist()


d <- c[str_detect(c,'rel=\"last\"')] 


f <- str_sub(d, str_locate(d, '&page=')[2]+1, str_locate(d, '>')[1]-1)

  return(f)
}
  commits(pkg_url)
 
}

```



```{r  trending-commits1}

commits <- c(get_commits("rtdists","fddm"),get_commits("r-lib","webfakes"),get_commits("nalzok","tree.interpreter"),get_commits("harryprince","geospark"),get_commits("cloudyr","AzureStor"),get_commits("spatstat","spatstat.core"),get_commits("Azure","AzureRMR"),get_commits("baddstats","spatstat.linnet"),get_commits("cran","clickstream"),get_commits("jeroen","js"),get_commits("spatstat","spatstat.sparse"),get_commits("ltorgo","DMwR2"),get_commits("daroczig","botor"),get_commits("timelyportfolio","sunburstR"),get_commits("jacob-long","panelr"),get_commits("markmfredrickson","RItools"),get_commits("DyfanJones","RAthena"),get_commits("jeroen","V8"),get_commits("timelyportfolio","d3r"),get_commits("daroczig","logger"),get_commits("dreamRs","fresh"),get_commits("nir0s","distro"),get_commits("h2oai","rsparkling"),get_commits("christophergandrud","DataCombine"),get_commits("quanteda","quanteda.textmodels"),get_commits("rstudio","bslib"),get_commits("rstudio","jquerylib"),get_commits("mclements","rstpm2"),get_commits("KlausVigo","phangorn"),get_commits("rstudio","sass"))



pkg_trending_commits <- cbind(pkg_trending_filter,commits) %>%
  select(-score)

# set the time range again (last half year)
date1 <- "2019-10-01"
date2 <- "2020-04-01"

# get last half year's total download for each package
trending_downloads <- get_total_downloads(pkg_trending_filter$package) 
  
 #combine the trending commits and trending downloads 
trending_downloads <- left_join(trending_downloads,pkg_trending_commits, by = "package")      

```

```{r commits-tbl}
trending_downloads %>%
  kable(caption = "Top 30 scored trending packages with commits on Github and last half year's downloads") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```

```{r commits-pattern, fig.align = 'center', fig.cap= "The package downloads of trending packages is increasing with the number of commits."}
trending_downloads %>%
  mutate(count = as.numeric(count)) %>%
  mutate(commits = as.numeric(commits)) %>%
  ggplot(aes(x = commits, y = count)) +
  geom_smooth(se = F) +
  labs( y = 'Total download count',
          x = 'The number of commits',
    title = "Commits counts against download counts",
    subtitle = "of top 30 trending packages for last half year") +
    annotate("text",y= 70000,x= 500,label="In general, more commits, more downloads.",color="red") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

```


## compare package score with the number of updates for top 30 trending package


```{r function-updates-downloads}

# function used to get total updates and total downloads for a vector of packages
get_updates_downloads <- function(packages){
  
update_count <- function(packages){

  
  # get all the update dates and compute the number of updates of each package  
pkg_trending_updates <- get_arcvupdate_date(packages) %>%
  group_by(package) %>%
  count(package) %>%
  rename(`number of updates` = n)

}

update_counts <- update_count(packages) 

# get total downloads for each package 
total_downloads <- get_total_downloads(update_counts$package)

# join data
update_counts <- update_counts %>%
  as.data.frame() %>%
  left_join(total_downloads,by = "package")

return(update_counts)

}


```

Figure \@ref(fig:trend-updates) shows that the number of downloads increases with the increase of update times.

```{r  trend-updates, fig.align = 'center', fig.cap=" The number of downloads increases with the increase of update times."}
pkg_trending_updates <- get_updates_downloads(pkg_trending$package) %>%
  mutate(score = as.numeric(count)) %>%
  mutate(updates = as.numeric(`number of updates`)) %>%
  arrange(desc(count))

pkg_trending_updates %>%
  ggplot(aes(x = `number of updates`, y = count)) +
  geom_smooth(se = F) +
    labs( x = 'The number of updates',
          y = 'Total download count',
    title = "Updates counts against download counts",
    subtitle = "for 100 trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```


Also checking Table \@ref(tab:pct-lowupdates), we can know that the percentage of trending packages whose updates are less than average is `r pct_trending_updates[2][1]`, which means much more than half of the 100 trending packages do not tend to update very frequently. 


```{r  function-lowupdates}
# function used to compute packages lying in the low-updated range

compute_pct_lowupdated <- function(packages){
  
avg_updates <- mean(as.numeric(get_updates_downloads(packages)$`number of updates`))

pkg_trending_total <- length(packages)

pct_trending_updates <- get_updates_downloads(packages) %>%
  mutate(`number of updates` = as.numeric(`number of updates`))  %>%
  filter(`number of updates` < avg_updates) %>%
  summarise(`number of packages with low updates` = length(package)) %>%
  mutate(`percentage of packages with low updates` = (`number of packages with low updates`/pkg_trending_total)*100)

pct_trending_updates%>%
  kable(caption = "Percentage of trending packages whose updates are less than average") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))

return(pct_trending_updates)

}

```

```{r pct-lowupdates}
# get the percentage of packages whose update counts is under the average
compute_pct_lowupdated(pkg_trending$package) 
  
```

It can be seen from Figure \@ref(fig:latestpublish) that most top 15 trending packages' latest publish date is after 2021, which indicates that popular packages tend to update by time to keep its activity. And this can also be explained from another aspect, that is, the a trending package refers to a package with a high download volume in a short period of recent time. We know that when a package is updated, its downloads will increase, so the latest update dates of trending packages are almost all the recent dates.

```{r function-latestupdate}
# function used to get the total downloads of a period of time and the latest release date
downloads_latest_release <- function(packages) {

# function used to get the latest release date from CRAN
latest_updates <- function(packages){
  
  latest_updates <- get_arcvupdate_date(packages) %>%
  group_by(package) %>%
  arrange(update, .by_group = TRUE) %>% #arrange within group
  top_n(1, update) # to get the latest release date, top_n() is used to select the highest value of a column within each group
  
}

latest_updates <- latest_updates(packages)

packages_vector <- latest_updates$package


# function used to get the total downloads of a period of time (date1 to date2) for several packages at the same time
get_total_downloads <- function(packages_vector){
  
total_downloads <- map(packages_vector, function(pkg){
  
  pkg <- cran_downloads(package = paste0(pkg), from = date1, to = date2) %>%
  summarise(package = package, count = sum(count)) %>%
  head(1)
  
})

 names(total_downloads) <- packages_vector

downloads <- unlist(total_downloads) %>% 
  enframe("package", "count") %>% 
  mutate(count = suppressWarnings(as.numeric(count)),
         # need to get rid of the numbers appended to pkg names
         package = str_extract(package, paste0(packages_vector, collapse="|")))%>%
         na.omit()
}

downloads <- get_total_downloads(packages_vector)
  
downloads_release_latest <- downloads %>%
  as.data.frame() %>%
  left_join(latest_updates,by = "package")

return(downloads_release_latest)
}
```

```{r  latestpublish,fig.align = 'center', fig.cap=" Most top 15 trending packages' latest publish date is after 2021."}

# before use the function 'downloads_latest_release()', please set the time range
date1 <- "2019-10-01"
date2 <- "2020-04-01"

pkg_trending1 <- pkg_trending %>%
  filter(!(package == "distro")) %>%
  filter(!(package == "decor")) %>%
  filter(!(package == "SeuratObject")) %>%
  filter(!(package == "bslib"))

pkg_trending_latest_publish <- unique(downloads_latest_release(pkg_trending1$package))

pkg_trending_latest_publish %>%
  ggplot(aes(update)) +
  geom_density() +
  labs( 
        x = 'Latest publish date',
    title = "Distribution of latest publish date",
    subtitle = "for trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```


```{r daily-updates}

pkg_trending_earliest_publish <- unique(downloads_earliest_release(pkg_trending_latest_publish$package))

pkg_trending_daily_update <- left_join(pkg_trending_earliest_publish,pkg_trending_latest_publish,by = "package") %>%
  select(-count.y) %>%
  rename(count = count.x) %>%
  mutate(release_days = as.numeric(update.y - update.x)) 

pkg_trending_daily_update$release_days <- as.character(pkg_trending_daily_update$release_days)
pkg_trending_daily_update$release_days[pkg_trending_daily_update$release_days == "0"] <- "1"

pkg_trending_daily_update$release_days <- as.numeric(pkg_trending_daily_update$release_days)

pkg_trending_daily_update <- pkg_trending_daily_update %>%
left_join(get_updates_downloads(pkg_trending_daily_update$package))

pkg_trending_daily_update %>%
  mutate(update_perday = `number of updates`/release_days) %>%
  ggplot(aes(x = update_perday, y = count)) +
  geom_smooth(se = F) +
  labs( y = 'Total download counts',
          x = 'The number of updates',
    title = "Daily update counts against the package score",
    subtitle = "for trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```


In conclusion, it's not that the more updates the package has, the popular it will be. In the trending package, most of the packages whose updates are lower than the average occupy the majority. Therefore, we can also know that the total number of updates is not very important for the trending package. The important thing is to keep it updated.


## compare the package name length with package score for trending packages

It can be seen that although the patterns of top 15 and last 15 are not the same, they all have one thing in common, that is, when the name length exceeds 8 characters, the package score will drop significantly. And when length is less than 4 characters, the score would not be ideal either.

```{r  namelength-plot}
# use the top 30 trending packages before 4.11
pkg_trending_30 <- pkg_trending %>%
  head(30)
 

pkg_trending_30_namelth <- pkg_trending_30 %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 

# to get the last 15 trending ones
pkg_trending_tail30 <- pkg_trending %>%
  tail(30) 

pkg_trending_tail30_namelth <- pkg_trending_tail30 %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 

# to get the name length for all trending packages before 4.11
  pkg_trending2 <- pkg_trending %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 
  
  
pkg_trending_30_namelth %>%
  ggplot(aes(x = length_name, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
        x = 'The length of package names',
    title = "Name length against the package score",
    subtitle = "for top 30 trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))


pkg_trending_tail30_namelth %>%
  ggplot(aes(x = length_name, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
        x = 'The length of package names',
    title = "Name length against the package score",
    subtitle = "for last 30 trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))

pkg_trending2 %>%
  ggplot(aes(x = length_name, y = score)) +
  geom_smooth(se = F) +
  labs( y = 'Score',
        x = 'The length of package names',
    title = "Name length against the package score",
    subtitle = "for all trending packages") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5))
```

```{r namelength}

# function used to get the name length and the percentage of packages whose name length is under total average
avg_namelth <- function(df){
    
  df1 <- df %>%
  mutate(length_name = nchar(package)) %>%
  mutate(score = as.numeric(score)) %>%
  mutate(length_name = as.numeric(length_name)) 
  
`total average name length` <- mean(pkg_trending1$length_name)
`average name length`  <- mean(df1$length_name)
pkg_trending_total <- length(df1$package)

df2 <- df1 %>%
  filter(length_name < `total average name length`) %>%
  summarise(`number of short names` = length(package)) %>%
  mutate(`percentage of short names` = (`number of short names`/pkg_trending_total)*100)

df2 <- cbind(df2,`average name length`,`total average name length`)

return(df2)
  
}


trending_top15_namelth <- avg_namelth(pkg_trending_15) %>%
  mutate(group = "top 15")

trending_tail15_namelth <- avg_namelth(pkg_trending_tail15) %>%
  mutate(group = "last 15")

trending_all_namelth <- avg_namelth(pkg_trending) %>%
  mutate(group = "all")

compare_trending_namelth <- rbind(trending_top15_namelth,trending_tail15_namelth,trending_all_namelth)
```

Table \@ref(tab:pct-lngname) shows that the average name length of last 15 packages is more close to the total average. And over half of the packages are more likely to have names longer than average for both top 15 and last 15, but this is more significant among top 15. That means top trending packages are more likely to have longer names.

```{r pct-lngname}
compare_trending_namelth %>%
  kable(caption = "Percentage of trending packages whose updates are less than average") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

```{r compute-ci}
# to get the 95% CI of the name length

# calculate the mean, sd and se
sample.mean <- mean(pkg_trending1$length_name)
sample.n <- length(pkg_trending1$length_name)
sample.sd <- sd(pkg_trending1$length_name)
sample.se <- sample.sd/sqrt(sample.n)

# find t-score
alpha <- 0.05
degrees.freedom <- sample.n - 1
t.score <- qt(p=alpha/2, df=degrees.freedom,lower.tail=F)

margin.error <- t.score * sample.se

# get the 95% CI
lower.bound <- sample.mean - margin.error
upper.bound <- sample.mean + margin.error

namelth_CI <- cbind(lower.bound,upper.bound)

```

Table \@ref(tab:pct-lngname) shows the 95% confidence interval of name length for trending packages. We could know that the 95% suitable name length is between 7 and 9 characters.

```{r namelth-ci}
namelth_CI %>%
  kable(caption = "95% Confidence Interval of name length for trending packages") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

