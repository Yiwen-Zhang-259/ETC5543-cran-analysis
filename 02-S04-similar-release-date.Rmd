## compare packages with similar release date

I would like to compare packages released on the same date (i.e. April 1st, 2021), so I compare the daily downloads of these packages for 04-02.

By looking into Figure \@ref(fig:pkg0401), we could know that the most downloaded package released on 04-01 is `datetimeutils`, and the second one is `berryFunctions`.

```{r}

```


## Compare moving average of fable and forecast

```{block, type="discovery", echo = TRUE}
**Finding x**: Package forecast has a more stable download trend comparing to fable. And when fable gets updated, its downloads peaked, while forecast suffers a dropping on the contrast.
```

In this section, we compare package `fable` and `forecast`. They are two closely related packages, for `fable` is the recently released tidy version of `forecast`. Figure \@ref(fig:daily-fbl) and Figure \@ref(fig:daily-fcst) shows the daily download count changing during last half year, which shows strong weekly seasonality. And that means the downloads tend to be higher in week days and thus lower on weekends, which is consistent with total package trend on CRAN.

```{r trans-ff}
lh_dt_start <- Sys.Date() - 183 - 2 #last half year
lh_dt_end <- Sys.Date() - 2

# transform the daily download of 'fable' to time series table
fable <- cran_downloads(package = "fable",from = lh_dt_start, to = lh_dt_end)
forecast <- cran_downloads(package = "forecast",from = lh_dt_start, to = lh_dt_end)

fable <- fable %>%
  as_tsibble(index = date) 

forecast <- forecast %>%
  as_tsibble(index = date) 
```

(ref:daily-fbl) The daily download of package "fable"

```{r daily-fbl, fig.cap="(ref:daily-fbl)}
fable %>%
  autoplot(count) +
   labs( y = 'Daily download count',
          x = 'Date',
    title = "The daily downloads of fable",
    subtitle = "for last half year") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 
  
```


(ref:daily-fcst) The daily download of package "forecast".

```{r  daily-fcst, fig.cap="(ref:daily-fcst)}
forecast %>%
  autoplot(count) +
   labs(  y = 'Daily download count',
          x = 'Date',
    title = "The daily downloads of forecast",
    subtitle = "for last half year") +
  scale_y_sqrt() +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 

```

Therefore, in order to estimate the trend-cycle and reduce the weekly seasonality to see the changes more clearly, I consider the equal weighed 7 moving average. That is, it calculates the weighted average for every seven consecutive time series with the following weights : [1/7,1/7,1/7,1/7,1/7,1/7,1/7]. 

Figure \@ref(fig:ff-ma) shows the moving average (MA) of `fable` and `forecast` respectively. They have quite different moving average patterns with `forecast`'s download volume much higher than `fable`'s. That is, the MA of `forecast` is relatively stable than that of `fable` except for the time around New Year's Eve when `forecast` has a significant drop. But during that time, a drop also appears in `fable`, which is probably due to the big New Year holiday. In addition, the purple vertical dashed line in plot of `fable` marks the update day of it which is on 2021-1-29. And on that day, its downloads peaked, which is because the number of download counts will increase on the update day.

(ref:ff-ma) The moving average of package "forecast" and "fable".

```{r ff-ma, fig.cap="(ref:ff-ma)}
# use 7 MA can get a equal weighed 7 MA 
fable_ma <- fable %>%
  mutate(
    `7-MA` = slider::slide_dbl(count, mean,
                .before = 3, .after = 3, .complete = TRUE)
    )

colors <- c('fable' = '#D55E00', 'forecast' = 'violetred4')

p_fbl <- fable_ma %>%
  autoplot(count, color = "gray") +
  geom_line(aes(y = `7-MA`,colour = 'fable')) +
  geom_vline(xintercept = as.numeric(ymd("2020-01-29")), linetype="dashed", #to get geom_vline to an x-axis of class date
                color = "violetred4", size=0.8) +
  labs( 
  title = "Weighed moving average of fable and forecast",
  subtitle = "from 2021-02-06 up to now") +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title.x=element_blank(),
  axis.title=element_text(size=12,face="bold"),
  plot.title = element_text(h = 0.5),
  plot.subtitle = element_text(h = 0.5)) 



forecast_ma <- forecast %>%
  mutate(
    `7-MA` = slider::slide_dbl(count, mean,
                .before = 3, .after = 3, .complete = TRUE)
    )

p_fcst <- forecast_ma %>%
  autoplot(count, color = "gray") +
  geom_line(aes(y = `7-MA`,colour = 'forecast')) +
  theme_minimal()  +
  theme(panel.grid.major = element_blank()) +
  theme(
  axis.text=element_text(size=10),
  axis.title=element_text(size=12,face="bold")) 


g_fbl <- ggplotGrob(p_fbl)
g_fcst <- ggplotGrob(p_fcst)
gff <- rbind(g_fbl, g_fcst, size = "first")
gff$widths <- unit.pmax(g_fbl$widths, g_fcst$widths)
grid.newpage()
grid.draw(gff)

```


